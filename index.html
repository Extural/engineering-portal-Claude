<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Portal - Home</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 3em;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .breadcrumb {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .breadcrumb a:hover {
            color: #764ba2;
        }

        .breadcrumb span {
            color: #7f8c8d;
            margin: 0 10px;
        }

        .nav-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .nav-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .nav-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            border-color: #667eea;
        }

        .nav-card .icon {
            font-size: 4em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-card h3 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .nav-card p {
            color: #7f8c8d;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .nav-card .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-coming-soon {
            background-color: #fff3cd;
            color: #856404;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .welcome-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stats-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .stat-card h4, .stat-card h3 {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .hidden {
            display: none;
        }

        /* Main content layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: fit-content;
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Grid layouts for forms */
        .two-column-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .two-column-row .form-group {
            margin-bottom: 0;
        }

        .three-column-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .three-column-row .form-group {
            margin-bottom: 0;
        }

        .four-column-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .four-column-row .form-group {
            margin-bottom: 0;
        }

        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table th:first-child,
        .data-table td:first-child {
            width: 120px;
            min-width: 120px;
            white-space: nowrap;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Priority and status badges */
        .priority-high { color: #e74c3c; font-weight: bold; }
        .priority-medium { color: #f39c12; font-weight: bold; }
        .priority-low { color: #27ae60; font-weight: bold; }

        .status-open { background-color: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; }
        .status-in-progress { background-color: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; }
        .status-resolved { background-color: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; }
        .status-completed { background-color: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; }
        .status-on-hold { background-color: #95a5a6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
        }

        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .nav-grid { grid-template-columns: 1fr; }
            .main-content { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .header h1 { font-size: 2em; }
            .stats-preview { grid-template-columns: repeat(2, 1fr); }
            .four-column-row { grid-template-columns: 1fr 1fr; }
            .three-column-row { grid-template-columns: 1fr 1fr; }
            .two-column-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .four-column-row, .three-column-row, .two-column-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status disconnected">Connecting to Database...</div>

    <div class="container">
        <div class="header">
            <h1>Engineering Portal</h1>
            <p>Streamlined Operations Management System</p>
        </div>

        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb" id="breadcrumb" style="display: none;">
            <a href="#" onclick="showHomePage()">Home</a>
            <span>></span>
            <span id="currentPage">Dashboard</span>
        </div>

        <!-- Home Page -->
        <div id="homePage">
            <div class="welcome-section">
                <h2>Welcome to the Engineering Portal</h2>
                <p>Your centralized hub for engineering operations, quality management, and task coordination. Access all essential tools and systems from this unified dashboard.</p>
                
                <div class="stats-preview">
                    <div class="stat-card">
                        <h4 id="homeOpenAlerts">0</h4>
                        <p>Open Quality Alerts</p>
                    </div>
                    <div class="stat-card">
                        <h4 id="homePendingTasks">0</h4>
                        <p>Pending Tasks</p>
                    </div>
                    <div class="stat-card">
                        <h4>24</h4>
                        <p>Active Projects</p>
                    </div>
                    <div class="stat-card">
                        <h4>98%</h4>
                        <p>System Uptime</p>
                    </div>
                </div>
				
				<div style="margin-top: 30px; text-align: center;">
					<h3 style="margin-bottom: 15px;">System Administration</h3>
					<button class="btn" onclick="showUserManagement()">User Management</button>
					<button class="btn" onclick="exportAllData()">Export All Data</button>
					<button class="btn" onclick="importData()">Import Backup</button>
				</div>
				
            </div>

            <div class="nav-section">
                <h2>System Modules</h2>
                <p>Select a module below to access its features and functionality.</p>
                
                <div class="nav-grid">
                    <div class="nav-card" onclick="showQualityAlerts()">
                        <div class="icon">üõ°Ô∏è</div>
                        <div class="status status-active">Active</div>
                        <h3>Quality Alert System</h3>
                        <p>Create, track, and manage quality alerts. Record issues, assign responsibilities, monitor progress, and generate reports for quality control processes.</p>
                        <button class="btn">Access Module ‚Üí</button>
                    </div>

                    <div class="nav-card" onclick="showTaskManagement()">
                        <div class="icon">üìã</div>
                        <div class="status status-active">Active</div>
                        <h3>Task Management</h3>
                        <p>Assign, track, and manage engineering tasks. Set priorities, deadlines, and monitor completion status across your team.</p>
                        <button class="btn">Access Module ‚Üí</button>
                    </div>

                    <div class="nav-card" onclick="showProjectManagementSecure()">
                        <div class="icon">üìä</div>
                        <div class="status status-active">Active</div>
                        <h3>Project Management</h3>
                        <p>Track tooling projects from creation to completion. Manage Pattern, Molds, Fixtures, and Programs with task breakdown and milestone tracking.</p>
                        <button class="btn">Access Module ‚Üí</button>
                    </div>

                    <div class="nav-card">
                        <div class="icon">üîß</div>
                        <div class="status status-coming-soon">Coming Soon</div>
                        <h3>Equipment Management</h3>
                        <p>Track equipment status, maintenance schedules, calibrations, and operational history for all engineering assets.</p>
                        <button class="btn btn-secondary" disabled>Module in Development</button>
                    </div>

                    <div class="nav-card">
                        <div class="icon">üìÑ</div>
                        <div class="status status-coming-soon">Coming Soon</div>
                        <h3>Document Control</h3>
                        <p>Centralized document management with version control, approval workflows, and secure access controls.</p>
                        <button class="btn btn-secondary" disabled>Module in Development</button>
                    </div>

                    <div class="nav-card">
                        <div class="icon">üìà</div>
                        <div class="status status-coming-soon">Coming Soon</div>
                        <h3>Analytics & Reporting</h3>
                        <p>Generate comprehensive reports and analytics across all engineering operations and quality metrics.</p>
                        <button class="btn btn-secondary" disabled>Module in Development</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Alerts Page -->
        <div id="qualityAlertsPage" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalAlerts">0</h3>
                    <p>Total Alerts</p>
                </div>
                <div class="stat-card">
                    <h3 id="openAlerts">0</h3>
                    <p>Open Alerts</p>
                </div>
                <div class="stat-card">
                    <h3 id="inProgressAlerts">0</h3>
                    <p>In Progress</p>
                </div>
                <div class="stat-card">
                    <h3 id="resolvedAlerts">0</h3>
                    <p>Resolved</p>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <h2>Quick Actions</h2>
                    <button class="btn" onclick="showCreateAlertFormSecure()">Create New Alert</button>
                    <button class="btn btn-secondary" onclick="showAllAlerts()">View All Alerts</button>
             
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Filter by Status</h3>
                    <button class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" onclick="filterAlertsByStatus('Open')">Open</button>
                    <button class="btn" onclick="filterAlertsByStatus('In Progress')">In Progress</button>
                    <button class="btn" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);" onclick="filterAlertsByStatus('Resolved')">Resolved</button>
					<button class="btn btn-secondary" onclick="clearAlertsFilters()" style="margin-top: 20px; width: 100%;">Clear All Filters</button>
					<h3 style="margin-top: 30px; margin-bottom: 15px;">Data Management</h3>
					<button class="btn btn-secondary" onclick="exportAlertsToCSV()">Export Alerts CSV</button>
					<button class="btn btn-secondary" onclick="importAlertsFromCSV()">Import Alerts CSV</button>
				</div>

                <div class="main-panel">
                    <div id="createAlertForm" class="hidden">
                        <h2 id="alertFormTitle">Create New Quality Alert</h2>
                        <form id="alertForm">
                            <div class="form-group">
                                <label for="alertId">Alert ID</label>
                                <input type="text" id="alertId" readonly>
                            </div>
                            <!-- ROW 1: FOUR MANUFACTURING FIELDS -->
                            <div class="four-column-row">
                                <div class="form-group">
                                    <label for="customerSupplier">Customer/Supplier</label>
                                    <input type="text" id="customerSupplier" placeholder="Customer name">
                                </div>
                                <div class="form-group">
                                    <label for="facility">Facility</label>
                                    <input type="text" id="facility" placeholder="Facility location">
                                </div>
                                <div class="form-group">
                                    <label for="partNumber">Part Number</label>
                                    <input type="text" id="partNumber" placeholder="Part number">
                                </div>
                                <div class="form-group">
                                    <label for="revisionLevel">Revision Level</label>
                                    <input type="text" id="revisionLevel" placeholder="Rev A, Rev 1.2">
                                </div>
                            </div>

                            <!-- ROW 2: THREE CONTACT FIELDS -->
                            <div class="three-column-row">
                                <div class="form-group">
                                    <label for="contact">Contact</label>
                                    <input type="text" id="contact" placeholder="Contact person name">
                                </div>
                                <div class="form-group">
                                    <label for="contactPhone">Contact Phone #</label>
                                    <input type="tel" id="contactPhone" placeholder="(555) 123-4567">
                                </div>
                                <div class="form-group">
                                    <label for="contactEmail">Contact Email</label>
                                    <input type="email" id="contactEmail" placeholder="contact@company.com">
                                </div>
                            </div>

                            <!-- ROW 3: THREE ASSIGNMENT FIELDS -->
                            <div class="three-column-row">
                                <div class="form-group">
                                    <label for="department">Department</label>
                                    <select id="department">
                                        <option value="">Select Department</option>
                                        <option value="Production">Production</option>
                                        <option value="Quality Control">Quality Control</option>
                                        <option value="Engineering">Engineering</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Safety">Safety</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="assignedTo">Assigned To</label>
                                    <input type="text" id="assignedTo" placeholder="Enter assigned person">
                                </div>
                                <div class="form-group">
                                    <label for="reportBy">Report By</label>
                                    <input type="date" id="reportBy">
                                </div>
                            </div>

                            <!-- ROW 4: FOUR REJECT FIELDS -->
                            <div class="four-column-row">
                                <div class="form-group">
									<label for="rejectCategory">Reject Category</label>
									<select id="rejectCategory" onchange="toggleCustomRejectCategory()">
										<option value="">Select Category</option>
										<option value="Dimensional">Dimensional</option>
										<option value="Surface Finish">Surface Finish</option>
										<option value="Material Defect">Material Defect</option>
										<option value="Assembly">Assembly</option>
										<option value="Packaging">Packaging</option>
										<option value="Documentation">Documentation</option>
										<option value="Custom">Custom (specify below)</option>
									</select>
									<input type="text" id="customRejectCategory" placeholder="Enter custom category" style="display: none; margin-top: 10px; width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em;">
								</div>
                                <div class="form-group">
                                    <label for="qtyRejected">Qty Rejected</label>
                                    <input type="number" id="qtyRejected" placeholder="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="qtyReturned">Qty Returned</label>
                                    <input type="number" id="qtyReturned" placeholder="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="qtyScrapped">Qty Scrapped</label>
                                    <input type="number" id="qtyScrapped" placeholder="0" min="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="description">Reason for Rejection *</label>
                                <textarea id="description" required placeholder="Describe the specific reason for rejection..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="rootCause">Root Cause</label>
                                <textarea id="rootCause" placeholder="Identify the underlying root cause of the issue..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="correctiveAction">Corrective/Preventive Action</label>
                                <textarea id="correctiveAction" placeholder="Describe actions taken or planned to correct and prevent recurrence..."></textarea>
                            </div>
                            
                            <!-- FOUR COLUMN ROW: PRIORITY, CLOSE DATE, SIGN OFF, STATUS -->
                            <div class="four-column-row">
                                <div class="form-group">
                                    <label for="priority">Priority *</label>
                                    <select id="priority" required>
                                        <option value="">Select Priority</option>
                                        <option value="High">High</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Low">Low</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="dueDate">Close Date</label>
                                    <input type="date" id="dueDate">
                                </div>
                                <div class="form-group">
                                    <label for="correctiveSignOff">Sign Off</label>
                                    <input type="text" id="correctiveSignOff" placeholder="Enter sign-off name">
                                </div>
                                <div class="form-group">
                                    <label for="alertStatus">Status</label>
                                    <select id="alertStatus">
                                        <option value="Open">Open</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Resolved">Resolved</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">Save Alert</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelAlertEdit()">Cancel</button>
                        </form>
                    </div>

                    <div id="alertsList">
                        <h2>Quality Alerts Dashboard</h2>
                        <input type="text" class="search-box" id="alertsSearchBox" placeholder="Search alerts..." onkeyup="searchAlerts()">
                        
                        <table class="data-table" id="alertsTable">
                            <thead>
                                <tr>
                                    <th>Alert ID</th>
                                    <th>Customer/Supplier</th>
                                    <th>Facility</th>
                                    <th>Part Number</th>
                                    <th>Revision Level</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Assigned To</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody">
                                <!-- Alerts will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Management Page -->
        <div id="taskManagementPage" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalTasks">0</h3>
                    <p>Total Tasks</p>
                </div>
                <div class="stat-card">
                    <h3 id="openTasks">0</h3>
                    <p>Open Tasks</p>
                </div>
                <div class="stat-card">
                    <h3 id="inProgressTasks">0</h3>
                    <p>In Progress</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedTasks">0</h3>
                    <p>Completed</p>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <h2>Quick Actions</h2>
                    <button class="btn" onclick="showCreateTaskFormSecure()">Create New Task</button>
                    <button class="btn btn-secondary" onclick="showAllTasks()">View All Tasks</button>
                    
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Filter by Priority</h3>
                    <button class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" onclick="filterTasksByPriority('High')">High Priority</button>
                    <button class="btn" onclick="filterTasksByPriority('Medium')">Medium Priority</button>
                    <button class="btn" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);" onclick="filterTasksByPriority('Low')">Low Priority</button>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Filter by Status</h3>
                    <button class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" onclick="filterTasksByStatus('Open')">Open</button>
                    <button class="btn" onclick="filterTasksByStatus('In Progress')">In Progress</button>
                    <button class="btn" style="background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);" onclick="filterTasksByStatus('On Hold')">On Hold</button>
                    <button class="btn" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);" onclick="filterTasksByStatus('Completed')">Completed</button>
                    
                    <button class="btn btn-secondary" onclick="clearTasksFilters()" style="margin-top: 20px; width: 100%;">Clear All Filters</button>
                
					<h3 style="margin-top: 30px; margin-bottom: 15px;">Data Management</h3>
					<button class="btn btn-secondary" onclick="exportTasksToCSV()">Export Tasks CSV</button>
				
				</div>

                <div class="main-panel">
                    <div id="createTaskForm" class="hidden">
                        <h2 id="taskFormTitle">Create New Task</h2>
                        <form id="taskForm">
                            <div class="form-group">
                                <label for="taskId">Task ID</label>
                                <input type="text" id="taskId" readonly>
                            </div>
                            
                            <div class="two-column-row">
                                <div class="form-group">
                                    <label for="taskTitle">Task Title *</label>
                                    <input type="text" id="taskTitle" required placeholder="Enter task title">
                                </div>
                                <div class="form-group">
                                    <label for="taskCategory">Category</label>
                                    <select id="taskCategory">
                                        <option value="">Select Category</option>
                                        <option value="Design">Design</option>
                                        <option value="Manufacturing">Manufacturing</option>
                                        <option value="Quality Control">Quality Control</option>
                                        <option value="Testing">Testing</option>
                                        <option value="Documentation">Documentation</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Research">Research</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="taskDescription">Task Description *</label>
                                <textarea id="taskDescription" required placeholder="Describe the task in detail..."></textarea>
                            </div>

                            <div class="three-column-row">
                                <div class="form-group">
                                    <label for="taskAssignee">Assigned To</label>
                                    <input type="text" id="taskAssignee" placeholder="Enter assignee name">
                                </div>
                                <div class="form-group">
                                    <label for="taskDepartment">Department</label>
                                    <select id="taskDepartment">
                                        <option value="">Select Department</option>
                                        <option value="Engineering">Engineering</option>
                                        <option value="Production">Production</option>
                                        <option value="Quality Control">Quality Control</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Research & Development">Research & Development</option>
                                        <option value="Safety">Safety</option>
                                    </select>
                                </div>
                            </div>

                            <div class="three-column-row">
                                <div class="form-group">
                                    <label for="taskPriority">Priority *</label>
                                    <select id="taskPriority" required>
                                        <option value="">Select Priority</option>
                                        <option value="High">High</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Low">Low</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskDueDate">Due Date</label>
                                    <input type="date" id="taskDueDate">
                                </div>
                                <div class="form-group">
                                    <label for="taskStatus">Status</label>
                                    <select id="taskStatus">
                                        <option value="Open">Open</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="On Hold">On Hold</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                            </div>

                            <div class="two-column-row">
                                <div class="form-group">
                                    <label for="taskEstimatedHours">Estimated Hours</label>
                                    <input type="number" id="taskEstimatedHours" placeholder="0" min="0" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="taskActualHours">Actual Hours</label>
                                    <input type="number" id="taskActualHours" placeholder="0" min="0" step="0.5">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="taskNotes">Notes</label>
                                <textarea id="taskNotes" placeholder="Add any additional notes or comments..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">Save Task</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelTaskEdit()">Cancel</button>
                        </form>
                    </div>

                    <div id="tasksList">
                        <h2>Task Management Dashboard</h2>
                        <input type="text" class="search-box" id="tasksSearchBox" placeholder="Search tasks..." onkeyup="searchTasks()">
                        
                        <table class="data-table" id="tasksTable">
                            <thead>
                                <tr>
                                    <th>Task ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Assigned To</th>
                                    <th>Department</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody">
                                <!-- Tasks will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
	
	<!-- Project Management Page -->
        <div id="projectsPage" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalProjects">0</h3>
                    <p>Total Projects</p>
                </div>
                <div class="stat-card">
                    <h3 id="planningProjects">0</h3>
                    <p>Planning</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeProjects">0</h3>
                    <p>In Progress</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedProjects">0</h3>
                    <p>Completed</p>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <h2>Quick Actions</h2>
					<button class="btn" onclick="showCreateProjectFormSecure()">Create New Project</button>
					<button class="btn btn-secondary" onclick="showAllProjects()">View All Projects</button>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Filter by Status</h3>
                    <button class="btn" onclick="filterProjectsByStatus('Planning')">Planning</button>
                    <button class="btn" onclick="filterProjectsByStatus('In Progress')">In Progress</button>
                    <button class="btn" onclick="filterProjectsByStatus('Completed')">Completed</button>
                    
                    <button class="btn btn-secondary" onclick="clearProjectsFilters()" style="margin-top: 20px; width: 100%;">Clear Filters</button>
                </div>

                <div class="main-panel">
                    <div id="createProjectForm" class="hidden">
                        <h2 id="projectFormTitle">Create New Project</h2>
                        <form id="projectForm" onsubmit="handleProjectSubmit(event)">
                            <input type="hidden" id="projectEditId">
                            
                            <div class="three-column-row">
                                <div class="form-group">
                                    <label for="projectNumber">Project Number *</label>
                                    <input type="text" id="projectNumber" required placeholder="PRJ-2025-001">
                                </div>
                                <div class="form-group">
                                    <label for="projectCustomer">Customer Name *</label>
                                    <input type="text" id="projectCustomer" required placeholder="Customer name">
                                </div>
                                <div class="form-group">
                                    <label for="projectPartNumber">Part Number *</label>
                                    <input type="text" id="projectPartNumber" required placeholder="Part number">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="projectPartDesc">Part Description</label>
                                <textarea id="projectPartDesc" placeholder="Description of the part"></textarea>
                            </div>

                            <div class="three-column-row">
                                <div class="form-group">
                                    <label for="projectManager">Project Manager</label>
                                    <input type="text" id="projectManager" placeholder="Manager name">
                                </div>
                                <div class="form-group">
                                    <label for="projectPriority">Priority *</label>
                                    <select id="projectPriority" required>
                                        <option value="High">High</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="Low">Low</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="projectStatus">Status</label>
                                    <select id="projectStatus">
                                        <option value="Planning" selected>Planning</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="On Hold">On Hold</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>

                            <div class="three-column-row">
                                <div class="form-group">
                                    <label for="projectStartDate">Start Date</label>
                                    <input type="date" id="projectStartDate">
                                </div>
                                <div class="form-group">
                                    <label for="projectTargetDate">Target Completion</label>
                                    <input type="date" id="projectTargetDate">
                                </div>
                                <div class="form-group">
                                    <label for="projectActualDate">Actual Completion</label>
                                    <input type="date" id="projectActualDate">
                                </div>
                            </div>

                            <h3 style="margin: 30px 0 20px 0; color: #667eea;">Tooling Requirements</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="needs_pattern" onchange="toggleToolingStatus('pattern')" style="margin-right: 10px; width: 18px; height: 18px;">
                                        <strong>Pattern</strong>
                                    </label>
                                    <select id="pattern_status" disabled style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="needs_oe_mold" onchange="toggleToolingStatus('oe_mold')" style="margin-right: 10px; width: 18px; height: 18px;">
                                        <strong>OE Mold</strong>
                                    </label>
                                    <select id="oe_mold_status" disabled style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="needs_me_mold" onchange="toggleToolingStatus('me_mold')" style="margin-right: 10px; width: 18px; height: 18px;">
                                        <strong>ME Mold</strong>
                                    </label>
                                    <select id="me_mold_status" disabled style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="needs_trim_fixture" onchange="toggleToolingStatus('trim_fixture')" style="margin-right: 10px; width: 18px; height: 18px;">
                                        <strong>Trim Fixture</strong>
                                    </label>
                                    <select id="trim_fixture_status" disabled style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="needs_assembly_fixture" onchange="toggleToolingStatus('assembly_fixture')" style="margin-right: 10px; width: 18px; height: 18px;">
                                        <strong>Assembly Fixture</strong>
                                    </label>
                                    <select id="assembly_fixture_status" disabled style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="needs_check_fixture" onchange="toggleToolingStatus('check_fixture')" style="margin-right: 10px; width: 18px; height: 18px;">
                                        <strong>Check Fixture</strong>
                                    </label>
                                    <select id="check_fixture_status" disabled style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="needs_drill_fixture" onchange="toggleToolingStatus('drill_fixture')" style="margin-right: 10px; width: 18px; height: 18px;">
                                        <strong>Drill Fixture</strong>
                                    </label>
                                    <select id="drill_fixture_status" disabled style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <input type="checkbox" id="needs_trim_program" onchange="toggleToolingStatus('trim_program')" style="margin-right: 10px; width: 18px; height: 18px;">
                                        <strong>Trim Program</strong>
                                    </label>
                                    <select id="trim_program_status" disabled style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Not Started">Not Started</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="projectNotes">Project Notes</label>
                                <textarea id="projectNotes" placeholder="Additional notes or requirements" rows="4"></textarea>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
							
							<!-- PROJECT DOCUMENTS SECTION -->
                            <div style="border-top: 2px solid #667eea; margin-top: 30px; padding-top: 30px;">
                                <h3 style="color: #667eea; margin-bottom: 20px;">Project Documents</h3>
                                
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Upload Document</label>
                                    <input type="file" id="projectDocUpload" multiple style="margin-bottom: 10px;">
                                    <select id="projectDocType" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px;">
                                        <option value="">Document Type</option>
                                        <option value="Drawing">Engineering Drawing</option>
                                        <option value="SOP">Standard Operating Procedure</option>
                                        <option value="Inspection">Inspection Report</option>
                                        <option value="Photo">Photo</option>
                                        <option value="Specification">Specification</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <input type="text" id="projectDocRevision" placeholder="Revision (optional)" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px; margin-right: 10px;">
                                    <button type="button" onclick="uploadProjectDocuments()" class="btn" style="padding: 8px 16px;">Upload Files</button>
                                </div>
                                
                                <div id="projectDocumentsList" style="margin-top: 20px;">
                                    <!-- Documents will be listed here -->
                                </div>
                            </div>
							
                                <button type="submit" class="btn">Save Project</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelProjectForm()">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div id="projectsList">
                        <h2>Projects</h2>
                        <table class="data-table" id="projectsTable">
                            <thead>
                                <tr>
                                    <th>Project #</th>
                                    <th>Customer</th>
                                    <th>Part Number</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Target Date</th>
                                    <th>Tooling</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTableBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px;">No projects found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    <!-- Load Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
	<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://ocrslcciwdpkgtrehkfg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jcnNsY2Npd2Rwa2d0cmVoa2ZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNTQ2NjEsImV4cCI6MjA3MDkzMDY2MX0.TpX8okjsPiwtH3xCjkWMVLOkc3YNvLf6suzHKL4tuJU';
        
		// EmailJS Configuration
		const EMAILJS_PUBLIC_KEY = '5UBPNb5GxaduPp4C6';
		const EMAILJS_SERVICE_ID = 'service_hyv1wjl';
		const EMAILJS_TEMPLATE_ID = 'template_yhquvxm';	
		
		// Initialize EmailJS
(function() {
    emailjs.init(EMAILJS_PUBLIC_KEY);
})();

// Send email notification function
async function sendAssignmentEmail(assigneeName, assigneeEmail, itemType, itemData) {
    try {
        const templateParams = {
            to_name: assigneeName,
            to_email: assigneeEmail,
            type: itemType,
            item_id: itemData.id,
            title: itemData.title || itemData.description.substring(0, 50),
            priority: itemData.priority,
            status: itemData.status,
            due_date: itemData.dueDate || 'Not set',
            description: itemData.description || itemData.title
        };
        
        const response = await emailjs.send(
            EMAILJS_SERVICE_ID,
            EMAILJS_TEMPLATE_ID,
            templateParams
        );
        
        console.log('Email sent successfully:', response);
        return true;
    } catch (error) {
        console.error('Email send failed:', error);
        return false;
    }
}
		
        // Application State
let currentPage = 'home';
let alerts = [];
let tasks = [];
let currentEditAlertId = null;
let currentEditTaskId = null;
let alertIdCounter = 1001;
let taskIdCounter = 2001;

// Check what columns the tasks table expects by trying a minimal insert
async function checkTasksSchema() {
    try {
        console.log('Testing tasks table structure...');
        
        // Try inserting a minimal record to see what fields are required/accepted
        const testData = {
            id: 9999,
            title: 'Test Task'
        };
        
        const result = await directApiCall('POST', 'tasks', testData);
        
        if (result.error) {
            console.log('Insert failed - this will show us what fields are missing/wrong:');
            console.log('Error message:', result.error.message);
        } else {
            console.log('Test insert succeeded. Now let\'s see the structure:');
            
            // Now fetch it back to see the actual structure
            const fetchResult = await directApiCall('GET', 'tasks?id=eq.9999');
            if (fetchResult.data && fetchResult.data.length > 0) {
                console.log('Tasks table columns:', Object.keys(fetchResult.data[0]));
                console.log('Sample data:', fetchResult.data[0]);
            }
            
            // Clean up the test record
            await directApiCall('DELETE', 'tasks?id=eq.9999');
        }
    } catch (error) {
        console.error('Schema test failed:', error);
    }
}

// Call it to see your actual columns
checkTasksSchema();

        // Update connection status indicator
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = message;
            statusEl.className = `connection-status ${status}`;
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // Direct API calls to Supabase REST API with detailed debugging
        async function directApiCall(method, endpoint, data = null) {
            try {
                const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
                console.log(`Making API call to: ${url}`);
                console.log(`Method: ${method}`);
                console.log(`SUPABASE_URL: ${SUPABASE_URL}`);
                console.log(`API Key (first 20 chars): ${SUPABASE_ANON_KEY.substring(0, 20)}...`);
                
                const headers = {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                };

                const config = {
                    method: method,
                    headers: headers
                };

                if (data && (method === 'POST' || method === 'PATCH')) {
                    config.body = JSON.stringify(data);
                    console.log('Request body:', config.body);
                }

                console.log('Request headers:', headers);
                console.log('Full request config:', config);

                const response = await fetch(url, config);
                
                console.log('Response status:', response.status);
                console.log('Response statusText:', response.statusText);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();
                console.log('API Success - Response data:', result);
                return { data: result, error: null };
            } catch (error) {
                console.error('API Call Exception:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                return { data: null, error: error };
            }
        }
async function testDatabaseConnection() {
    try {
        console.log('Testing database connection...');
        updateConnectionStatus('disconnected', 'Testing Database...');
        
        const testUrl = `${SUPABASE_URL}/rest/v1/`;
        console.log('Testing connection to:', testUrl);
        
        const healthCheck = await fetch(testUrl, {
            method: 'GET',
            headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
        });
        
        console.log('Health check response status:', healthCheck.status);
        
        if (!healthCheck.ok) {
            throw new Error(`Health check failed: ${healthCheck.status}`);
        }
        
        console.log('Health check passed, trying to query quality_alerts...');
        
        const result = await directApiCall('GET', 'quality_alerts?limit=1');
        
        if (result.error) {
            throw result.error;
        }
        
        console.log('Database connection successful!');
        console.log('Sample data from database:', result.data);
        updateConnectionStatus('connected', 'Database Connected');
        
        // Load both alerts and tasks from database
        await loadAlertsFromDatabase();
        await loadTasksFromDatabase();
        
    } catch (error) {
        console.error('Database connection failed:', error);
        console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            name: error.name
        });
        
        updateConnectionStatus('disconnected', `Database Error: ${error.message}`);
        
        console.log('Loading sample data as fallback...');
        loadSampleData();
        updateAllStats();
    }
}

        // Load alerts from database
        async function loadAlertsFromDatabase() {
            try {
                console.log('Loading alerts from database...');
                const result = await directApiCall('GET', 'quality_alerts?order=created_at.desc');
                
                if (result.error) {
                    throw result.error;
                }
                
                const data = result.data;
                console.log('Raw data from database:', data);
                
                // Map database columns to our UI format
                alerts = (data || []).map(item => ({
                    id: `QA-${item.id}`,
                    description: item.qa_number || '',
                    rootCause: item.root_cause || '',
                    correctiveAction: item.corrective_action || '',
                    correctiveSignOff: item.corrective_sign_off || '',
                    priority: item.priority || 'Medium',
                    status: item.status || 'Open',
                    assignedTo: item.assigned_to || '',
                    department: item.department || '',
                    facility: item.facility || '',
                    createdDate: item.date_complaint || new Date().toISOString().split('T')[0],
                    dueDate: item.date_complaint || '',
                    partNumber: item.part_number || '',
                    customerSupplier: item.customer_supplier || '',
                    revisionLevel: item.revision_level || '',
                    contact: item.contact || '',
                    contactPhone: item.contact_phone || '',
                    contactEmail: item.contact_email || '',
                    reportBy: item.report_by || '',
                    // Reject fields
                    rejectCategory: item.reject_category || '',
                    qtyRejected: item.qty_rejected || 0,
                    qtyReturned: item.qty_returned || 0,
                    qtyScrapped: item.qty_scrapped || 0
                }));
                
                console.log('Mapped alerts:', alerts);
                
                if (alerts.length > 0) {
                    const numericIds = alerts.map(a => parseInt(a.id.replace('QA-', '')) || 0);
                    const maxId = Math.max(...numericIds);
                    alertIdCounter = maxId + 1;
                    console.log('Set alertIdCounter to:', alertIdCounter);
                }
                
                // Load sample tasks data for now
                loadTasksSampleData();
                
                updateConnectionStatus('connected', 'Data Loaded');
                updateAllStats();
                
            } catch (error) {
				console.error('Failed to load tasks from database:', error);
				loadTasksSampleData();
				taskIdCounter = 2001;  // ‚Üê ADD THIS LINE TO OVERRIDE
				return false;
			}
        }

        // ADD THIS - Load tasks from database with correct field mappings
async function loadTasksFromDatabase() {
    try {
        console.log('Loading tasks from database...');
        const result = await directApiCall('GET', 'tasks?order=created_date.desc');
        
        if (result.error) {
            throw result.error;
        }
        
        const data = result.data;
        console.log('Raw tasks data from database:', data);
		console.log('First task raw data:', data[0]);
		console.log('assigned_to field value:', data[0]?.assigned_to);
        
        // Map database columns to UI format
        tasks = (data || []).map(item => ({
            id: `TK-${item.id}`,
            title: item.title || '',
            category: item.category || '',
            description: item.description || '',
            assignee: item.assigned_to || '',
            department: item.task_type || '', // DB: task_type ‚Üí UI: department
            priority: item.priority || 'Medium',
            status: item.status || 'Open',
            dueDate: item.due_date || '',
            estimatedHours: item.estimated_hours || 0,
            actualHours: item.progress || 0, // DB: progress ‚Üí UI: actualHours
            notes: item.notes || '',
            createdDate: item.created_date || new Date().toISOString().split('T')[0]
        }));
        
		console.log('Mapped tasks:', tasks);
		console.log('First mapped task:', tasks[0]);
		console.log('Mapped assignee field:', tasks[0]?.assignee);
        
        if (tasks.length > 0) {
            const numericIds = tasks.map(t => parseInt(t.id.replace('TK-', '')) || 0);
            const maxId = Math.max(...numericIds);
            taskIdCounter = maxId + 1;
            console.log('Set taskIdCounter to:', taskIdCounter);
        }
        
        console.log('Tasks loaded successfully from database');
        return true;
        
    } catch (error) {
        console.error('Failed to load tasks from database:', error);
        loadTasksSampleData();
        return false;
    }
}

// ADD THIS - Save task to database
async function saveTaskToDatabase(taskData) {
    try {
        console.log('=== SAVE TASK DEBUG ===');
        console.log('Full taskData object:', taskData);
        
        const numericId = taskData.id.replace('TK-', '');
        const existingTask = tasks.find(t => t.id === taskData.id);
        const isUpdating = !!existingTask;
		
		
        
const dbData = {
    title: taskData.title,
    category: taskData.category || null,
    description: taskData.description,
    assigned_to: taskData.assignee || null,  // ‚Üê FIXED: assignee ‚Üí assigned_to
    task_type: taskData.department || null,
    priority: taskData.priority,
    status: taskData.status,
    due_date: taskData.dueDate || null,
    estimated_hours: parseFloat(taskData.estimatedHours) || null,
    progress: parseFloat(taskData.actualHours) || null,
    created_date: taskData.createdDate || new Date().toISOString().split('T')[0]
    // REMOVED: reporter field (doesn't exist in DB)
};

console.log('=== TASK ASSIGNEE DEBUG ===');
console.log('taskData.assignee:', taskData.assignee);
console.log('assigned_to in dbData:', dbData.assigned_to);
console.log('Full dbData:', dbData); 
 
        if (isUpdating) {
            const result = await directApiCall('PATCH', `tasks?id=eq.${numericId}`, dbData);
            if (result.error) throw result.error;
        } else {
            dbData.id = parseInt(numericId);
            const result = await directApiCall('POST', 'tasks', dbData);
            if (result.error) throw result.error;
            taskIdCounter++;
        }

        return true;
    } catch (error) {
        console.error('Task save failed:', error);
        alert(`Database Error: ${error.message}`);
        return false;
    }
}

// ADD THIS - Delete task from database
async function deleteTaskFromDatabase(id) {
    try {
        const numericId = id.replace('TK-', '');
        const result = await directApiCall('DELETE', `tasks?id=eq.${parseInt(numericId)}`);
        
        if (result.error) throw result.error;
        tasks = tasks.filter(t => t.id !== id);
        return true;
    } catch (error) {
        console.error('Error deleting task:', error);
        alert('Error deleting from database. Please try again.');
        return false;
    }
}
	

	// Save alert to database
        async function saveAlertToDatabase(alertData) {
            try {
                console.log('=== SAVE ALERT DEBUG ===');
                console.log('Full alertData object:', alertData);
                
                const numericId = alertData.id.replace('QA-', '');
                const existingAlert = alerts.find(a => a.id === alertData.id);
                const isUpdating = !!existingAlert;
                
                console.log('Numeric ID:', numericId);
                console.log('Is updating existing alert?', isUpdating);

                const dbData = {
					qa_number: alertData.description,
					root_cause: alertData.rootCause,
					corrective_action: alertData.correctiveAction,
					corrective_sign_off: alertData.correctiveSignOff,
					priority: alertData.priority,
					assigned_to: alertData.assignedTo,
					facility: alertData.facility,
					department: alertData.department,  // ‚Üê ADD THIS LINE
					status: alertData.status,
					date_complaint: alertData.dueDate || null,
					part_number: alertData.partNumber || null,
					customer_supplier: alertData.customerSupplier || null,
					revision_level: alertData.revisionLevel || null,
					contact: alertData.contact || null,
					contact_phone: alertData.contactPhone || null,
					contact_email: alertData.contactEmail || null,
					report_by: alertData.reportBy || null,
					reject_category: alertData.rejectCategory || null,
					qty_rejected: parseInt(alertData.qtyRejected) || null,
					qty_returned: parseInt(alertData.qtyReturned) || null,
					qty_scrapped: parseInt(alertData.qtyScrapped) || null
				};
                
                console.log('Database payload:', dbData);
                
                if (isUpdating) {
                    console.log('Attempting UPDATE...');
                    const result = await directApiCall('PATCH', `quality_alerts?id=eq.${numericId}`, dbData);
                    console.log('UPDATE result:', result);
                    
                    if (result.error) {
                        console.error('UPDATE failed:', result.error);
                        throw result.error;
                    }
                    
                    console.log('Alert updated successfully');
                } else {
                    console.log('Attempting INSERT...');
                    dbData.id = parseInt(numericId);
                    console.log('INSERT payload with ID:', dbData);
                    
                    const result = await directApiCall('POST', 'quality_alerts', dbData);
                    console.log('INSERT result:', result);
                    
                    if (result.error) {
                        console.error('INSERT failed:', result.error);
                        throw result.error;
                    }
                    
                    console.log('Alert created successfully');
                    alertIdCounter++;
                }

                console.log('=== SAVE COMPLETED SUCCESSFULLY ===');
				

				
                return true;
            } catch (error) {
                console.error('=== SAVE FAILED ===');
                console.error('Error details:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                alert(`Database Error: ${error.message}\n\nCheck browser console for details.`);
                return false;
            }
        }

        // Delete alert from database
        async function deleteAlertFromDatabase(id) {
            try {
                const numericId = id.replace('QA-', '');
                const result = await directApiCall('DELETE', `quality_alerts?id=eq.${parseInt(numericId)}`);
                
                if (result.error) throw result.error;
                alerts = alerts.filter(a => a.id !== id);
                return true;
            } catch (error) {
                console.error('Error deleting alert:', error);
                alert('Error deleting from database. Please try again.');
                return false;
            }
        }

        // Load sample tasks data (since we don't have tasks database table yet)
        function loadTasksSampleData() {
            tasks = [
                {
                    id: 'TK-2001',
                    title: 'Update CNC Machine Calibration Procedures',
                    category: 'Documentation',
                    description: 'Review and update the standard operating procedures for CNC machine calibration to include new quality standards and measurement protocols.',
                    assignee: 'Mike Davis',
                    department: 'Engineering',
                    reporter: 'Jane Wilson',
                    priority: 'High',
                    status: 'Open',
                    dueDate: '2025-10-15',
                    estimatedHours: 8,
                    actualHours: 0,
                    notes: 'Coordinate with Quality Control team for review',
                    createdDate: '2025-09-20'
                },
                {
                    id: 'TK-2002',
                    title: 'Implement Preventive Maintenance Schedule',
                    category: 'Maintenance',
                    description: 'Develop and implement a comprehensive preventive maintenance schedule for all production equipment to reduce downtime and improve reliability.',
                    assignee: 'Tom Rodriguez',
                    department: 'Maintenance',
                    reporter: 'Susan Lee',
                    priority: 'Medium',
                    status: 'In Progress',
                    dueDate: '2025-10-30',
                    estimatedHours: 20,
                    actualHours: 12,
                    notes: 'Phase 1 complete - equipment audit finished',
                    createdDate: '2025-09-15'
                },
                {
                    id: 'TK-2003',
                    title: 'Design New Fixture for Part XYZ-456',
                    category: 'Design',
                    description: 'Create engineering drawings and prototype for new holding fixture to improve machining accuracy and reduce setup time.',
                    assignee: 'Lisa Chen',
                    department: 'Engineering',
                    reporter: 'Mark Thompson',
                    priority: 'Medium',
                    status: 'Completed',
                    dueDate: '2025-09-25',
                    estimatedHours: 16,
                    actualHours: 18,
                    notes: 'Prototype tested successfully, ready for production',
                    createdDate: '2025-09-10'
                },
                {
                    id: 'TK-2004',
                    title: 'Safety Training Module Development',
                    category: 'Documentation',
                    description: 'Develop comprehensive safety training materials for new equipment operators, including video content and assessment modules.',
                    assignee: 'Robert Kim',
                    department: 'Safety',
                    reporter: 'Jennifer Adams',
                    priority: 'High',
                    status: 'On Hold',
                    dueDate: '2025-11-01',
                    estimatedHours: 25,
                    actualHours: 5,
                    notes: 'Waiting for approval from corporate safety department',
                    createdDate: '2025-09-18'
                }
            ];
            taskIdCounter = 2001;
        }

        // Load sample data for both alerts and tasks (fallback when database fails)
        function loadSampleData() {
            // Sample alerts data
            alerts = [
                {
                    id: 'QA-1001',
                    customerSupplier: 'ABC Manufacturing Corp',
                    facility: 'Building A - Line 3',
                    partNumber: 'ABC-123-456',
                    revisionLevel: 'Rev C',
                    contact: 'John Smith',
                    contactPhone: '(555) 123-4567',
                    contactEmail: 'john.smith@abcmfg.com',
                    department: 'Quality Control',
                    assignedTo: 'John Smith',
                    reportBy: '2025-09-05',
                    rejectCategory: 'Dimensional',
                    qtyRejected: 25,
                    qtyReturned: 20,
                    qtyScrapped: 5,
                    description: 'Parts consistently measuring 0.002" over tolerance on critical dimension 4.250¬±0.001".',
                    rootCause: 'Spindle bearing wear causing machine drift during extended production runs.',
                    correctiveAction: 'Replace spindle bearings and implement hourly dimension checks.',
                    correctiveSignOff: '',
                    priority: 'High',
                    status: 'Open',
                    createdDate: '2025-09-01',
                    dueDate: '2025-09-05'
                },
                {
                    id: 'QA-1002',
                    customerSupplier: 'XYZ Automotive',
                    facility: 'Building B - CNC Department',
                    partNumber: 'XYZ-789-012',
                    revisionLevel: 'Rev 2.1',
                    contact: 'Sarah Johnson',
                    contactPhone: '(555) 987-6543',
                    contactEmail: 'sarah.j@xyzauto.com',
                    department: 'Production',
                    assignedTo: 'Sarah Johnson',
                    reportBy: '2025-09-08',
                    rejectCategory: 'Surface Finish',
                    qtyRejected: 12,
                    qtyReturned: 12,
                    qtyScrapped: 0,
                    description: 'Surface roughness measurements exceeding Ra 3.2 ¬µm specification.',
                    rootCause: 'Cutting tool exceeded recommended tool life.',
                    correctiveAction: 'Implemented tool life tracking system.',
                    correctiveSignOff: 'M. Anderson - Production Mgr',
                    priority: 'Medium',
                    status: 'In Progress',
                    createdDate: '2025-09-02',
                    dueDate: '2025-09-08'
                }
            ];

            // Load tasks sample data
            loadTasksSampleData();

            alertIdCounter = 1003;
        }

        // Generate new alert and task IDs
        function generateAlertId() {
            document.getElementById('alertId').value = `QA-${alertIdCounter}`;
        }

        function generateTaskId() {
    console.log('Current taskIdCounter:', taskIdCounter);
    console.log('Current tasks array:', tasks);
    document.getElementById('taskId').value = `TK-${taskIdCounter}`;
}
		
        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Engineering Portal starting up...');
            generateAlertId();
            generateTaskId();
            showHomePage();
            
            setTimeout(() => {
                testDatabaseConnection();
            }, 1000);
        });

        // Navigation Functions
        function showHomePage() {
            currentPage = 'home';
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('qualityAlertsPage').classList.add('hidden');
            document.getElementById('taskManagementPage').classList.add('hidden');
            document.getElementById('breadcrumb').style.display = 'none';
            updateHomeStats();
        }

        function showQualityAlerts() {
            currentPage = 'qualityAlerts';
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('qualityAlertsPage').classList.remove('hidden');
            document.getElementById('taskManagementPage').classList.add('hidden');
            document.getElementById('breadcrumb').style.display = 'block';
            document.getElementById('currentPage').textContent = 'Quality Alerts';
            showAllAlerts();
            updateAlertsStats();
        }

        function showTaskManagement() {
            currentPage = 'taskManagement';
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('qualityAlertsPage').classList.add('hidden');
            document.getElementById('taskManagementPage').classList.remove('hidden');
            document.getElementById('breadcrumb').style.display = 'block';
            document.getElementById('currentPage').textContent = 'Task Management';
            showAllTasks();
            updateTasksStats();
        }

        // Quality Alerts Functions
        function showCreateAlertForm() {
            document.getElementById('createAlertForm').classList.remove('hidden');
            document.getElementById('alertsList').classList.add('hidden');
            currentEditAlertId = null;
            document.getElementById('alertForm').reset();
            generateAlertId();
            document.getElementById('alertStatus').value = 'Open';
            document.getElementById('alertFormTitle').textContent = 'Create New Quality Alert';
            document.getElementById('alertFormTitle').style.color = '#2c3e50';
        }

        function showAllAlerts() {
            document.getElementById('createAlertForm').classList.add('hidden');
            document.getElementById('alertsList').classList.remove('hidden');
            displayAlerts(alerts);
        }

        function displayAlerts(alertsToShow) {
            const tableBody = document.getElementById('alertsTableBody');
            tableBody.innerHTML = '';

            alertsToShow.forEach(alert => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${alert.id}</td>
                    <td>${alert.customerSupplier || 'N/A'}</td>
                    <td>${alert.facility || 'N/A'}</td>
                    <td>${alert.partNumber || 'N/A'}</td>
                    <td>${alert.revisionLevel || 'N/A'}</td>
                    <td class="priority-${alert.priority.toLowerCase()}">${alert.priority}</td>
                    <td><span class="status-${alert.status.toLowerCase().replace(' ', '-')}">${alert.status}</span></td>
                    <td>${alert.assignedTo || 'Unassigned'}</td>
                    <td>${formatDate(alert.createdDate)}</td>
                    <td>
                        <button class="btn edit-alert-btn" data-alert-id="${alert.id}" style="padding: 8px 12px; margin: 2px;">Edit</button>
                        <button class="btn btn-secondary print-alert-btn" data-alert-id="${alert.id}" style="padding: 8px 12px; margin: 2px;">Print</button>
                        <button class="btn delete-alert-btn" data-alert-id="${alert.id}" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 8px 12px; margin: 2px;">Delete</button>
                    </td>
                `;
            });
            
            addAlertButtonEventListeners();
        }

        function addAlertButtonEventListeners() {
            document.querySelectorAll('.edit-alert-btn').forEach(button => {
                button.addEventListener('click', function() {
                    editAlert(this.getAttribute('data-alert-id'));
                });
            });
            
            document.querySelectorAll('.print-alert-btn').forEach(button => {
                button.addEventListener('click', function() {
                    printAlert(this.getAttribute('data-alert-id'));
                });
            });
            
            document.querySelectorAll('.delete-alert-btn').forEach(button => {
                button.addEventListener('click', function() {
                    deleteAlert(this.getAttribute('data-alert-id'));
                });
            });
        }

        function editAlert(id) {
            const alert = alerts.find(a => a.id === id);
            if (!alert) return;

            currentEditAlertId = id;
            
            document.getElementById('createAlertForm').classList.remove('hidden');
            document.getElementById('alertsList').classList.add('hidden');
            
            document.getElementById('alertFormTitle').textContent = `Edit Quality Alert ${id}`;
            document.getElementById('alertFormTitle').style.color = '#f39c12';
            
            // Populate all form fields
            document.getElementById('alertId').value = alert.id;
            document.getElementById('customerSupplier').value = alert.customerSupplier || '';
            document.getElementById('facility').value = alert.facility || '';
            document.getElementById('partNumber').value = alert.partNumber || '';
            document.getElementById('revisionLevel').value = alert.revisionLevel || '';
            document.getElementById('contact').value = alert.contact || '';
            document.getElementById('contactPhone').value = alert.contactPhone || '';
            document.getElementById('contactEmail').value = alert.contactEmail || '';
            document.getElementById('department').value = alert.department || '';
            document.getElementById('assignedTo').value = alert.assignedTo || '';
            document.getElementById('reportBy').value = alert.reportBy || '';
            document.getElementById('rejectCategory').value = alert.rejectCategory || '';
			document.getElementById('rejectCategory').value = alert.rejectCategory || '';
			// Handle custom categories when editing
			if (alert.rejectCategory && !['', 'Dimensional', 'Surface Finish', 'Material Defect', 'Assembly', 'Packaging', 'Documentation'].includes(alert.rejectCategory)) {
				document.getElementById('rejectCategory').value = 'Custom';
				document.getElementById('customRejectCategory').value = alert.rejectCategory;
				toggleCustomRejectCategory();
			}
            document.getElementById('qtyRejected').value = alert.qtyRejected || '';
            document.getElementById('qtyReturned').value = alert.qtyReturned || '';
            document.getElementById('qtyScrapped').value = alert.qtyScrapped || '';
            document.getElementById('description').value = alert.description || '';
            document.getElementById('rootCause').value = alert.rootCause || '';
            document.getElementById('correctiveAction').value = alert.correctiveAction || '';
            document.getElementById('priority').value = alert.priority || '';
            document.getElementById('dueDate').value = alert.dueDate || '';
            document.getElementById('correctiveSignOff').value = alert.correctiveSignOff || '';
            document.getElementById('alertStatus').value = alert.status || '';
        }

        function deleteAlert(id) {
            if (confirm('Are you sure you want to delete this alert?')) {
                deleteAlertFromDatabase(id).then(success => {
                    if (success) {
                        displayAlerts(alerts);
                        updateAllStats();
                    }
                });
            }
        }

        function cancelAlertEdit() {
            currentEditAlertId = null;
            showAllAlerts();
        }

        // Alert form submission
        document.getElementById('alertForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const alertData = {
                id: document.getElementById('alertId').value,
                customerSupplier: document.getElementById('customerSupplier').value,
                facility: document.getElementById('facility').value,
                partNumber: document.getElementById('partNumber').value,
                revisionLevel: document.getElementById('revisionLevel').value,
                contact: document.getElementById('contact').value,
                contactPhone: document.getElementById('contactPhone').value,
                contactEmail: document.getElementById('contactEmail').value,
                department: document.getElementById('department').value,
                assignedTo: document.getElementById('assignedTo').value,
                reportBy: document.getElementById('reportBy').value,
                rejectCategory: (() => {
					const selectValue = document.getElementById('rejectCategory').value;
					const customValue = document.getElementById('customRejectCategory').value;
					return selectValue === 'Custom' ? customValue : selectValue;
				})(),
                qtyRejected: document.getElementById('qtyRejected').value,
                qtyReturned: document.getElementById('qtyReturned').value,
                qtyScrapped: document.getElementById('qtyScrapped').value,
                description: document.getElementById('description').value,
                rootCause: document.getElementById('rootCause').value,
                correctiveAction: document.getElementById('correctiveAction').value,
                priority: document.getElementById('priority').value,
                dueDate: document.getElementById('dueDate').value,
                correctiveSignOff: document.getElementById('correctiveSignOff').value,
                status: document.getElementById('alertStatus').value,
                createdDate: currentEditAlertId ? alerts.find(a => a.id === currentEditAlertId)?.createdDate : new Date().toISOString().split('T')[0]
            };

			const isNewAlert = !currentEditAlertId;
            const success = await saveAlertToDatabase(alertData);
            
			if (success && isNewAlert && alertData.assignedTo) {
        const users = await loadUsersFromDatabase();
        const assignedUser = users.find(u => u.full_name === alertData.assignedTo);
        
        if (assignedUser && assignedUser.email) {
            await sendAssignmentEmail(
                assignedUser.full_name,
                assignedUser.email,
                'Quality Alert',
                {
                    id: alertData.id,
                    title: alertData.description.substring(0, 100),
                    description: alertData.description,
                    priority: alertData.priority,
                    status: alertData.status,
                    dueDate: alertData.dueDate
                }
            );
        }
    }
			
            if (success) {
                currentEditAlertId = null;
                await loadAlertsFromDatabase();
                showAllAlerts();
                updateAllStats();
                alert('Alert saved successfully!');
            }
        });

        // Search and filter functions for alerts
        function searchAlerts() {
			const searchTerm = document.getElementById('alertsSearchBox').value.toLowerCase();
			const filteredAlerts = alerts.filter(alert =>
				alert.description.toLowerCase().includes(searchTerm) ||
				(alert.assignedTo && alert.assignedTo.toLowerCase().includes(searchTerm)) ||
				(alert.department && alert.department.toLowerCase().includes(searchTerm)) ||
				(alert.customerSupplier && alert.customerSupplier.toLowerCase().includes(searchTerm)) ||
				(alert.facility && alert.facility.toLowerCase().includes(searchTerm)) ||
				(alert.partNumber && alert.partNumber.toLowerCase().includes(searchTerm)) ||
				alert.id.toLowerCase().includes(searchTerm)
			);
			displayAlerts(filteredAlerts);
}

        function filterAlertsByPriority(priority) {
            displayAlerts(alerts.filter(alert => alert.priority === priority));
        }

        function filterAlertsByStatus(status) {
            displayAlerts(alerts.filter(alert => alert.status === status));
        }

        function clearAlertsFilters() {
            document.getElementById('alertsSearchBox').value = '';
            displayAlerts(alerts);
        }

        function exportAlertsData() {
			exportAlertsToCSV(); // Use the new CSV export function
		}

        // Print alert function with professional formatting
        function printAlert(id) {
            const alert = alerts.find(a => a.id === id);
            if (!alert) return;

            const printContent = `
                <div style="max-width: 900px; margin: 0 auto; font-family: Arial, sans-serif; padding: 20px;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                        <h1 style="color: #2c3e50; margin-bottom: 5px; font-size: 28px;">VEE Engineering, Inc.</h1>
                        <h2 style="color: #667eea; margin-bottom: 10px; font-size: 24px;">Quality Alert/6D Report</h2>
                        <div style="margin-top: 15px;">
                            <strong style="font-size: 20px; color: #667eea;">Alert ID: ${alert.id}</strong>
                        </div>
                    </div>
                    
                    <!-- ROW 1: Manufacturing Details -->
                    <div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Manufacturing Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px;">
                            <div style="border-right: 1px solid #dee2e6; padding-right: 15px;">
                                <strong>Customer/Supplier:</strong><br>
                                <span style="display: inline-block; min-width: 150px; padding: 2px 0;">${alert.customerSupplier || ''}</span>
                            </div>
                            <div style="border-right: 1px solid #dee2e6; padding: 0 15px;">
                                <strong>Facility:</strong><br>
                                <span style="display: inline-block; min-width: 150px; padding: 2px 0;">${alert.facility || ''}</span>
                            </div>
                            <div style="border-right: 1px solid #dee2e6; padding: 0 15px;">
                                <strong>Part Number:</strong><br>
                                <span style="display: inline-block; min-width: 150px; padding: 2px 0;">${alert.partNumber || ''}</span>
                            </div>
                            <div style="padding-left: 15px;">
                                <strong>Revision Level:</strong><br>
                                <span style="display: inline-block; min-width: 150px; padding: 2px 0;">${alert.revisionLevel || ''}</span>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 2: Contact Information -->
                    <div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Contact Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <div style="border-right: 1px solid #dee2e6; padding-right: 15px;">
                                <strong>Contact Person:</strong><br>
                                <span style="display: inline-block; min-width: 180px; padding: 2px 0;">${alert.contact || ''}</span>
                            </div>
                            <div style="border-right: 1px solid #dee2e6; padding: 0 15px;">
                                <strong>Phone Number:</strong><br>
                                <span style="display: inline-block; min-width: 180px; padding: 2px 0;">${alert.contactPhone || ''}</span>
                            </div>
                            <div style="padding-left: 15px;">
                                <strong>Email Address:</strong><br>
                                <span style="display: inline-block; min-width: 180px; padding: 2px 0;">${alert.contactEmail || ''}</span>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 3: Assignment Details -->
                    <div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Assignment Details</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <div style="border-right: 1px solid #dee2e6; padding-right: 15px;">
                                <strong>Department:</strong><br>
                                <span style="display: inline-block; min-width: 180px; padding: 2px 0;">${alert.department || ''}</span>
                            </div>
                            <div style="border-right: 1px solid #dee2e6; padding: 0 15px;">
                                <strong>Assigned To:</strong><br>
                                <span style="display: inline-block; min-width: 180px; padding: 2px 0;">${alert.assignedTo || ''}</span>
                            </div>
                            <div style="padding-left: 15px;">
                                <strong>Report By:</strong><br>
                                <span style="display: inline-block; min-width: 180px; padding: 2px 0;">${alert.reportBy ? formatDate(alert.reportBy) : ''}</span>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 4: Reject Data -->
                    <div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Reject Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px;">
                            <div style="border-right: 1px solid #dee2e6; padding-right: 15px;">
                                <strong>Reject Category:</strong><br>
                                <span style="display: inline-block; min-width: 150px; padding: 2px 0;">${alert.rejectCategory || ''}</span>
                            </div>
                            <div style="border-right: 1px solid #dee2e6; padding: 0 15px;">
                                <strong>Qty Rejected:</strong><br>
                                <span style="display: inline-block; min-width: 150px; padding: 2px 0;">${alert.qtyRejected || ''}</span>
                            </div>
                            <div style="border-right: 1px solid #dee2e6; padding: 0 15px;">
                                <strong>Qty Returned:</strong><br>
                                <span style="display: inline-block; min-width: 150px; padding: 2px 0;">${alert.qtyReturned || ''}</span>
                            </div>
                            <div style="padding-left: 15px;">
                                <strong>Qty Scrapped:</strong><br>
                                <span style="display: inline-block; min-width: 150px; padding: 2px 0;">${alert.qtyScrapped || ''}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Reason for Rejection -->
                    <div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Reason for Rejection</h3>
                        <div style="border: 1px solid #ccc; padding: 10px; min-height: 80px; background: #f9f9f9;">
                            ${alert.description || '<em style="color: #999;">Not specified</em>'}
                        </div>
                    </div>

                    ${alert.rootCause ? `<div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Root Cause Analysis</h3>
                        <div style="border: 1px solid #ccc; padding: 10px; min-height: 80px; background: #f9f9f9;">
                            ${alert.rootCause}
                        </div>
                    </div>` : `<div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Root Cause Analysis</h3>
                        <div style="border: 1px solid #ccc; padding: 10px; min-height: 80px; background: #f9f9f9;">
                            <em style="color: #999;">To be completed</em>
                        </div>
                    </div>`}

                    ${alert.correctiveAction ? `<div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Corrective/Preventive Action</h3>
                        <div style="border: 1px solid #ccc; padding: 10px; min-height: 80px; background: #f9f9f9;">
                            ${alert.correctiveAction}
                        </div>
                    </div>` : `<div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 20px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Corrective/Preventive Action</h3>
                        <div style="border: 1px solid #ccc; padding: 10px; min-height: 80px; background: #f9f9f9;">
                            <em style="color: #999;">To be completed</em>
                        </div>
                    </div>`}

                    <!-- Final Row: Status Information -->
                    <div style="border: 2px solid #667eea; border-radius: 8px; margin-bottom: 30px; padding: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; border-bottom: 1px solid #667eea; padding-bottom: 5px;">Status & Closure Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px;">
                            <div style="border-right: 1px solid #dee2e6; padding-right: 15px;">
                                <strong>Priority:</strong><br>
                                <span style="display: inline-block; min-width: 120px; padding: 2px 0; font-weight: bold; color: ${alert.priority === 'High' ? '#e74c3c' : alert.priority === 'Medium' ? '#f39c12' : '#27ae60'};">${alert.priority}</span>
                            </div>
                            <div style="border-right: 1px solid #dee2e6; padding: 0 15px;">
                                <strong>Close Date:</strong><br>
                                <span style="display: inline-block; min-width: 120px; padding: 2px 0;">${alert.dueDate ? formatDate(alert.dueDate) : ''}</span>
                            </div>
                            <div style="border-right: 1px solid #dee2e6; padding: 0 15px;">
                                <strong>Sign Off:</strong><br>
                                <span style="display: inline-block; min-width: 120px; padding: 2px 0;">${alert.correctiveSignOff || ''}</span>
                            </div>
                            <div style="padding-left: 15px;">
                                <strong>Status:</strong><br>
                                <span style="display: inline-block; min-width: 120px; padding: 2px 0; font-weight: bold;">${alert.status}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 40px; border-top: 2px solid #667eea; padding-top: 20px; color: #7f8c8d;">
                        <p style="margin: 5px 0;"><strong>Generated:</strong> ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                        <p style="margin: 5px 0;"><strong>Created:</strong> ${formatDate(alert.createdDate)}</p>
                        <p style="margin: 15px 0 5px 0; font-weight: bold; color: #667eea;">VEE Engineering, Inc. - Quality Alert System</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #999;">VE-QY4 / (09/17/2025) / Rev B</p>
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quality Alert ${alert.id}</title>
                    <style>
                        body { 
                            margin: 0; 
                            font-family: Arial, sans-serif;
                        }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        @media screen {
                            body { background: #f5f5f5; padding: 20px; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Task Management Functions
        function showCreateTaskForm() {
            document.getElementById('createTaskForm').classList.remove('hidden');
            document.getElementById('tasksList').classList.add('hidden');
            currentEditTaskId = null;
            document.getElementById('taskForm').reset();
            generateTaskId();
            document.getElementById('taskStatus').value = 'Open';
            document.getElementById('taskFormTitle').textContent = 'Create New Task';
            document.getElementById('taskFormTitle').style.color = '#2c3e50';
        }

        function showAllTasks() {
            document.getElementById('createTaskForm').classList.add('hidden');
            document.getElementById('tasksList').classList.remove('hidden');
            displayTasks(tasks);
        }

        function displayTasks(tasksToShow) {
            const tableBody = document.getElementById('tasksTableBody');
            tableBody.innerHTML = '';

            tasksToShow.forEach(task => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.title}</td>
                    <td>${task.category || 'N/A'}</td>
                    <td>${task.assignee || 'Unassigned'}</td>
                    <td>${task.department || 'N/A'}</td>
                    <td class="priority-${task.priority.toLowerCase()}">${task.priority}</td>
                    <td><span class="status-${task.status.toLowerCase().replace(' ', '-')}">${task.status}</span></td>
                    <td>${task.dueDate ? formatDate(task.dueDate) : 'No due date'}</td>
                    <td>
                        <button class="btn edit-task-btn" data-task-id="${task.id}" style="padding: 8px 12px; margin: 2px;">Edit</button>
                        <button class="btn delete-task-btn" data-task-id="${task.id}" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 8px 12px; margin: 2px;">Delete</button>
                    </td>
                `;
            });
            
            addTaskButtonEventListeners();
        }

        function addTaskButtonEventListeners() {
            document.querySelectorAll('.edit-task-btn').forEach(button => {
                button.addEventListener('click', function() {
                    editTask(this.getAttribute('data-task-id'));
                });
            });
            
            document.querySelectorAll('.delete-task-btn').forEach(button => {
                button.addEventListener('click', function() {
                    deleteTask(this.getAttribute('data-task-id'));
                });
            });
        }

        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            currentEditTaskId = id;
            
            document.getElementById('createTaskForm').classList.remove('hidden');
            document.getElementById('tasksList').classList.add('hidden');
            
            document.getElementById('taskFormTitle').textContent = `Edit Task ${id}`;
            document.getElementById('taskFormTitle').style.color = '#f39c12';
            
            // Populate form fields
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskCategory').value = task.category || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskAssignee').value = task.assignee || '';
            document.getElementById('taskDepartment').value = task.department || '';
            document.getElementById('taskPriority').value = task.priority || '';
            document.getElementById('taskDueDate').value = task.dueDate || '';
            document.getElementById('taskStatus').value = task.status || '';
            document.getElementById('taskEstimatedHours').value = task.estimatedHours || '';
            document.getElementById('taskActualHours').value = task.actualHours || '';
            document.getElementById('taskNotes').value = task.notes || '';
        }

function deleteTask(id) {
    if (confirm('Are you sure you want to delete this task?')) {
        deleteTaskFromDatabase(id).then(success => {
            if (success) {
                displayTasks(tasks);
                updateAllStats();
            }
        });
    }
}

        function cancelTaskEdit() {
            currentEditTaskId = null;
            showAllTasks();
        }

        // Task form submission
document.getElementById('taskForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const taskData = {
        id: document.getElementById('taskId').value,
        title: document.getElementById('taskTitle').value,
        category: document.getElementById('taskCategory').value,
        description: document.getElementById('taskDescription').value,
        assignee: document.getElementById('taskAssignee').value,
        department: document.getElementById('taskDepartment').value,
        priority: document.getElementById('taskPriority').value,
        dueDate: document.getElementById('taskDueDate').value,
        status: document.getElementById('taskStatus').value,
        estimatedHours: parseFloat(document.getElementById('taskEstimatedHours').value) || 0,
        actualHours: parseFloat(document.getElementById('taskActualHours').value) || 0,
        notes: document.getElementById('taskNotes').value,
        createdDate: currentEditTaskId ? tasks.find(t => t.id === currentEditTaskId)?.createdDate : new Date().toISOString().split('T')[0]
    };
	
	const isNewTask = !currentEditTaskId;
    const success = await saveTaskToDatabase(taskData);
    
	// Send email only for NEW tasks
if (success && isNewTask && taskData.assignee) {
    const users = await loadUsersFromDatabase();
    const assignedUser = users.find(u => u.full_name === taskData.assignee);
    
    if (assignedUser && assignedUser.email) {
        await sendAssignmentEmail(
            assignedUser.full_name,
            assignedUser.email,
            'Task',
            taskData
        );
    }
}
	
    if (success) {
        currentEditTaskId = null;
        await loadTasksFromDatabase();
        showAllTasks();
        updateAllStats();
        alert('Task saved successfully!');
    }
});

        // Search and filter functions for tasks
        function searchTasks() {
            const searchTerm = document.getElementById('tasksSearchBox').value.toLowerCase();
            const filteredTasks = tasks.filter(task =>
                task.title.toLowerCase().includes(searchTerm) ||
                task.description.toLowerCase().includes(searchTerm) ||
                (task.assignee && task.assignee.toLowerCase().includes(searchTerm)) ||
                (task.department && task.department.toLowerCase().includes(searchTerm)) ||
                (task.category && task.category.toLowerCase().includes(searchTerm)) ||
                task.id.toLowerCase().includes(searchTerm)
            );
            displayTasks(filteredTasks);
        }

        function filterTasksByPriority(priority) {
            displayTasks(tasks.filter(task => task.priority === priority));
        }

        function filterTasksByStatus(status) {
            displayTasks(tasks.filter(task => task.status === status));
        }

        function clearTasksFilters() {
            document.getElementById('tasksSearchBox').value = '';
            displayTasks(tasks);
        }

        function exportTasksData() {
            const dataStr = JSON.stringify(tasks, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `engineering_tasks_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Statistics update functions
        function updateHomeStats() {
            const openAlertsCount = alerts.filter(a => a.status === 'Open').length;
            const pendingTasksCount = tasks.filter(t => t.status === 'Open' || t.status === 'In Progress').length;
            
            document.getElementById('homeOpenAlerts').textContent = openAlertsCount;
            document.getElementById('homePendingTasks').textContent = pendingTasksCount;
        }

        function updateAlertsStats() {
            const total = alerts.length;
            const open = alerts.filter(a => a.status === 'Open').length;
            const inProgress = alerts.filter(a => a.status === 'In Progress').length;
            const resolved = alerts.filter(a => a.status === 'Resolved').length;

            document.getElementById('totalAlerts').textContent = total;
            document.getElementById('openAlerts').textContent = open;
            document.getElementById('inProgressAlerts').textContent = inProgress;
            document.getElementById('resolvedAlerts').textContent = resolved;
        }

        function updateTasksStats() {
            const total = tasks.length;
            const open = tasks.filter(t => t.status === 'Open').length;
            const inProgress = tasks.filter(t => t.status === 'In Progress').length;
            const completed = tasks.filter(t => t.status === 'Completed').length;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('openTasks').textContent = open;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('completedTasks').textContent = completed;
        }

        function updateAllStats() {
            updateHomeStats();
            updateAlertsStats();
            updateTasksStats();
        }

        // Utility function
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }
		
		// User Management and Security System for Engineering Portal

// Global user state
let currentUser = null;
let userPermissions = {};

// User roles and permissions
const USER_ROLES = {
    ADMIN: 'admin',
    MANAGER: 'manager', 
    ENGINEER: 'engineer',
    VIEWER: 'viewer'
};

const PERMISSIONS = {
    // Quality Alerts
    CREATE_ALERTS: 'create_alerts',
    EDIT_ALERTS: 'edit_alerts',
    DELETE_ALERTS: 'delete_alerts',
    VIEW_ALERTS: 'view_alerts',
    CLOSE_ALERTS: 'close_alerts',
    
    // Tasks
    CREATE_TASKS: 'create_tasks',
    EDIT_TASKS: 'edit_tasks',
    DELETE_TASKS: 'delete_tasks',
    VIEW_TASKS: 'view_tasks',
    ASSIGN_TASKS: 'assign_tasks',
    
    // System
    MANAGE_USERS: 'manage_users',
    EXPORT_DATA: 'export_data',
    IMPORT_DATA: 'import_data',
    SYSTEM_ADMIN: 'system_admin'
};

// Role-based permissions mapping
const ROLE_PERMISSIONS = {
    [USER_ROLES.ADMIN]: Object.values(PERMISSIONS),
    [USER_ROLES.MANAGER]: [
        PERMISSIONS.CREATE_ALERTS, PERMISSIONS.EDIT_ALERTS, PERMISSIONS.VIEW_ALERTS, PERMISSIONS.CLOSE_ALERTS,
        PERMISSIONS.CREATE_TASKS, PERMISSIONS.EDIT_TASKS, PERMISSIONS.VIEW_TASKS, PERMISSIONS.ASSIGN_TASKS,
        PERMISSIONS.EXPORT_DATA, PERMISSIONS.IMPORT_DATA
    ],
    [USER_ROLES.ENGINEER]: [
		PERMISSIONS.EDIT_ALERTS, PERMISSIONS.VIEW_ALERTS,
		PERMISSIONS.EDIT_TASKS, PERMISSIONS.VIEW_TASKS,
		PERMISSIONS.EXPORT_DATA
	],
    [USER_ROLES.VIEWER]: [
        PERMISSIONS.VIEW_ALERTS, PERMISSIONS.VIEW_TASKS, PERMISSIONS.EXPORT_DATA
    ]
};

// Initialize user management
function initializeUserManagement() {
    // Check if user is logged in from localStorage
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        userPermissions = ROLE_PERMISSIONS[currentUser.role] || [];
        updateUIForUser();
    } else {
        showLoginForm();
    }
}

// Show login form
function showLoginForm() {
    const loginModal = `
        <div id="loginModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Engineering Portal Login</h2>
                <form id="loginForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Username:</label>
                        <input type="text" id="loginUsername" required style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Password:</label>
                        <input type="password" id="loginPassword" required style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em;">
                    </div>
                    <button type="submit" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer;">Login</button>
                </form>
                
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', loginModal);
    
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleLogin();
    });
}

// Handle login
function handleLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    // Demo user validation (replace with real authentication)
    const demoUsers = {
        'admin': { password: 'admin123', role: USER_ROLES.ADMIN, name: 'System Administrator' },
        'manager': { password: 'mgr123', role: USER_ROLES.MANAGER, name: 'Quality Manager' },
        'engineer': { password: 'eng123', role: USER_ROLES.ENGINEER, name: 'Design Engineer' },
        'viewer': { password: 'view123', role: USER_ROLES.VIEWER, name: 'Quality Inspector' }
    };
    
    const user = demoUsers[username];
    if (user && user.password === password) {
        currentUser = {
            username: username,
            name: user.name,
            role: user.role,
            loginTime: new Date().toISOString()
        };
        
        userPermissions = ROLE_PERMISSIONS[user.role] || [];
        
        // Save to localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // Remove login modal
        document.getElementById('loginModal').remove();
        
        // Update UI
        updateUIForUser();
        
        alert(`Welcome ${currentUser.name}!\nRole: ${currentUser.role}\nPermissions: ${userPermissions.length} modules accessible`);
    } else {
        alert('Invalid username or password');
    }
}

// Update UI based on user permissions
function updateUIForUser() {
    if (!currentUser) return;
    
    // Add user info to header
    addUserInfoToHeader();
    
    // Hide/show navigation based on permissions
    updateNavigationAccess();
    
    // Hide/show buttons based on permissions
    updateButtonAccess();
    
    // Update form access
    updateFormAccess();
}

// Add user info to header
function addUserInfoToHeader() {
    const header = document.querySelector('.header');
    const existingUserInfo = document.getElementById('userInfo');
    
    if (existingUserInfo) {
        existingUserInfo.remove();
    }
    
    const userInfo = `
        <div id="userInfo" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); padding: 10px 15px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <div style="font-weight: 600; color: #2c3e50;">${currentUser.name}</div>
            <div style="font-size: 0.9em; color: #7f8c8d;">${currentUser.role}</div>
            <button onclick="logout()" style="margin-top: 5px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">Logout</button>
        </div>
    `;
    
    header.style.position = 'relative';
    header.insertAdjacentHTML('beforeend', userInfo);
}

// Update navigation access
function updateNavigationAccess() {
    // Quality Alerts module
    const qaCard = document.querySelector('.nav-card[onclick="showQualityAlerts()"]');
    if (qaCard) {
        if (hasPermission(PERMISSIONS.VIEW_ALERTS)) {
            qaCard.style.display = 'block';
        } else {
            qaCard.style.display = 'none';
        }
    }
    
    // Task Management module
    const taskCard = document.querySelector('.nav-card[onclick="showTaskManagement()"]');
    if (taskCard) {
        if (hasPermission(PERMISSIONS.VIEW_TASKS)) {
            taskCard.style.display = 'block';
        } else {
            taskCard.style.display = 'none';
        }
    }
}

// Update button access
function updateButtonAccess() {
    // Create buttons
    const createAlertBtn = document.querySelector('button[onclick="showCreateAlertForm()"]');
    if (createAlertBtn) {
        createAlertBtn.style.display = hasPermission(PERMISSIONS.CREATE_ALERTS) ? 'inline-block' : 'none';
    }
    
    const createTaskBtn = document.querySelector('button[onclick="showCreateTaskForm()"]');
    if (createTaskBtn) {
        createTaskBtn.style.display = hasPermission(PERMISSIONS.CREATE_TASKS) ? 'inline-block' : 'none';
    }
    
    // Export/Import buttons
    const exportBtns = document.querySelectorAll('button[onclick*="export"], button[onclick*="Export"]');
    exportBtns.forEach(btn => {
        btn.style.display = hasPermission(PERMISSIONS.EXPORT_DATA) ? 'inline-block' : 'none';
    });
    
    const importBtns = document.querySelectorAll('button[onclick*="import"], button[onclick*="Import"]');
    importBtns.forEach(btn => {
        btn.style.display = hasPermission(PERMISSIONS.IMPORT_DATA) ? 'inline-block' : 'none';
    });
}

// Update form access
function updateFormAccess() {
    // Make forms read-only for viewers
    if (currentUser.role === USER_ROLES.VIEWER) {
        const inputs = document.querySelectorAll('#createAlertForm input, #createAlertForm select, #createAlertForm textarea');
        inputs.forEach(input => {
            input.disabled = true;
        });
        
        const taskInputs = document.querySelectorAll('#createTaskForm input, #createTaskForm select, #createTaskForm textarea');
        taskInputs.forEach(input => {
            input.disabled = true;
        });
    }
}

// Permission checking function
function hasPermission(permission) {
    return userPermissions.includes(permission);
}

// Check permission with error message
function requirePermission(permission, action = 'perform this action') {
    if (!hasPermission(permission)) {
        alert(`Access denied. You don't have permission to ${action}.`);
        return false;
    }
    return true;
}

// Logout function
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        currentUser = null;
        userPermissions = {};
        localStorage.removeItem('currentUser');
        location.reload();
    }
}

// Enhanced alert creation with permission check
function showCreateAlertFormSecure() {
    if (!requirePermission(PERMISSIONS.CREATE_ALERTS, 'create quality alerts')) {
        return;
    }
    showCreateAlertForm();
}

// Enhanced task creation with permission check
function showCreateTaskFormSecure() {
    if (!requirePermission(PERMISSIONS.CREATE_TASKS, 'create tasks')) {
        return;
    }
    showCreateTaskForm();
}

// Enhanced delete functions with permission checks
function deleteAlertSecure(id) {
    if (!requirePermission(PERMISSIONS.DELETE_ALERTS, 'delete alerts')) {
        return;
    }
    deleteAlert(id);
}

function deleteTaskSecure(id) {
    if (!requirePermission(PERMISSIONS.DELETE_TASKS, 'delete tasks')) {
        return;
    }
    deleteTask(id);
}

// Enhanced edit functions with permission checks
function editAlertSecure(id) {
    if (!requirePermission(PERMISSIONS.EDIT_ALERTS, 'edit alerts')) {
        return;
    }
    editAlert(id);
}

function editTaskSecure(id) {
    if (!requirePermission(PERMISSIONS.EDIT_TASKS, 'edit tasks')) {
        return;
    }
    editTask(id);
}

// Audit logging function
function logUserAction(action, details = {}) {
    const logEntry = {
        timestamp: new Date().toISOString(),
        user: currentUser ? currentUser.username : 'anonymous',
        action: action,
        details: details,
        ip: 'client-side' // In real implementation, get from server
    };
    
    console.log('Audit Log:', logEntry);
    
    // Store in localStorage for demo (use database in production)
    const auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
    auditLog.push(logEntry);
    
    // Keep last 100 entries
    if (auditLog.length > 100) {
        auditLog.splice(0, auditLog.length - 100);
    }
    
    localStorage.setItem('auditLog', JSON.stringify(auditLog));
}

// User management interface (admin only)
function showUserManagement() {
    if (!requirePermission(PERMISSIONS.MANAGE_USERS, 'manage users')) {
        return;
    }
    
    const userMgmtModal = `
        <div id="userMgmtModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
            <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">User Management</h2>
                
                <div style="margin-bottom: 30px;">
                    <h3>Current Session</h3>
                    <p><strong>User:</strong> ${currentUser.name} (${currentUser.username})</p>
                    <p><strong>Role:</strong> ${currentUser.role}</p>
                    <p><strong>Login Time:</strong> ${new Date(currentUser.loginTime).toLocaleString()}</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3>System Users</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #dee2e6;">Username</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">Name</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">Role</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">Permissions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td style="padding: 10px; border: 1px solid #dee2e6;">admin</td><td style="padding: 10px; border: 1px solid #dee2e6;">System Administrator</td><td style="padding: 10px; border: 1px solid #dee2e6;">admin</td><td style="padding: 10px; border: 1px solid #dee2e6;">All permissions</td></tr>
                            <tr><td style="padding: 10px; border: 1px solid #dee2e6;">manager</td><td style="padding: 10px; border: 1px solid #dee2e6;">Quality Manager</td><td style="padding: 10px; border: 1px solid #dee2e6;">manager</td><td style="padding: 10px; border: 1px solid #dee2e6;">Create, Edit, View, Export</td></tr>
                            <tr><td style="padding: 10px; border: 1px solid #dee2e6;">engineer</td><td style="padding: 10px; border: 1px solid #dee2e6;">Design Engineer</td><td style="padding: 10px; border: 1px solid #dee2e6;">engineer</td><td style="padding: 10px; border: 1px solid #dee2e6;">Create, Edit, View</td></tr>
                            <tr><td style="padding: 10px; border: 1px solid #dee2e6;">viewer</td><td style="padding: 10px; border: 1px solid #dee2e6;">Quality Inspector</td><td style="padding: 10px; border: 1px solid #dee2e6;">viewer</td><td style="padding: 10px; border: 1px solid #dee2e6;">View only</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="closeUserManagement()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', userMgmtModal);
}

function closeUserManagement() {
    const modal = document.getElementById('userMgmtModal');
    if (modal) modal.remove();
}

// Dynamic User Management System for Engineering Portal

// First, you'll need to create a 'users' table in your Supabase database
// CREATE TABLE users (
//     id SERIAL PRIMARY KEY,
//     username VARCHAR(50) UNIQUE NOT NULL,
//     password_hash VARCHAR(255) NOT NULL,
//     full_name VARCHAR(100) NOT NULL,
//     email VARCHAR(100),
//     role VARCHAR(20) NOT NULL,
//     is_active BOOLEAN DEFAULT true,
//     created_at TIMESTAMP DEFAULT NOW(),
//     created_by VARCHAR(50),
//     last_login TIMESTAMP
// );

// Load users from database
async function loadUsersFromDatabase() {
    try {
        const result = await directApiCall('GET', 'users?is_active=eq.true&order=username.asc');
        if (result.error) {
            console.error('Failed to load users:', result.error);
            return [];
        }
        return result.data || [];
    } catch (error) {
        console.error('Error loading users:', error);
        return [];
    }
}

// Enhanced login function that checks database
async function handleLoginDatabase() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
        // First try database users
        const users = await loadUsersFromDatabase();
        const dbUser = users.find(u => u.username === username);
        
        if (dbUser && await verifyPassword(password, dbUser.password_hash)) {
            // Database user found and password matches
            currentUser = {
                id: dbUser.id,
                username: dbUser.username,
                name: dbUser.full_name,
                email: dbUser.email,
                role: dbUser.role,
                loginTime: new Date().toISOString()
            };
            
            // Update last login
            await directApiCall('PATCH', `users?id=eq.${dbUser.id}`, {
                last_login: new Date().toISOString()
            });
            
            loginSuccess();
            return;
        }
        
        // Fall back to demo users if database doesn't have the user
        const demoUsers = {
            'admin': { password: 'admin123', role: USER_ROLES.ADMIN, name: 'System Administrator' },
            'manager': { password: 'mgr123', role: USER_ROLES.MANAGER, name: 'Quality Manager' },
            'engineer': { password: 'eng123', role: USER_ROLES.ENGINEER, name: 'Design Engineer' },
            'viewer': { password: 'view123', role: USER_ROLES.VIEWER, name: 'Quality Inspector' }
        };
        
        const demoUser = demoUsers[username];
        if (demoUser && demoUser.password === password) {
            currentUser = {
                username: username,
                name: demoUser.name,
                role: demoUser.role,
                loginTime: new Date().toISOString()
            };
            
            loginSuccess();
            return;
        }
        
        alert('Invalid username or password');
        
    } catch (error) {
        console.error('Login error:', error);
        alert('Login system error. Please try again.');
    }
}

// Login success helper
function loginSuccess() {
    userPermissions = ROLE_PERMISSIONS[currentUser.role] || [];
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    document.getElementById('loginModal').remove();
    updateUIForUser();
    alert(`Welcome ${currentUser.name}!\nRole: ${currentUser.role}`);
}

// Simple password verification (in production, use proper hashing)
async function verifyPassword(inputPassword, storedHash) {
    // For demo purposes, we'll store plain text passwords
    // In production, use bcrypt or similar hashing
    return inputPassword === storedHash;
}

// Hash password (simplified for demo)
function hashPassword(password) {
    // In production, use proper password hashing like bcrypt
    // For demo, we'll store plain text (NOT SECURE)
    return password;
}

// Add new user to database
async function addNewUser(userData) {
    try {
        const newUser = {
            username: userData.username,
            password_hash: hashPassword(userData.password), // In production, hash this properly
            full_name: userData.fullName,
            email: userData.email,
            role: userData.role,
            is_active: true,
            created_at: new Date().toISOString(),
            created_by: currentUser ? currentUser.username : 'system'
        };
        
        const result = await directApiCall('POST', 'users', newUser);
        
        if (result.error) {
            throw result.error;
        }
        
        return true;
    } catch (error) {
        console.error('Error adding user:', error);
        return false;
    }
}

// Enhanced User Management interface with add user functionality
function showUserManagementEnhanced() {
    if (!requirePermission(PERMISSIONS.MANAGE_USERS, 'manage users')) {
        return;
    }
    
    loadUsersFromDatabase().then(dbUsers => {
        const userMgmtModal = `
            <div id="userMgmtModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
                <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 1000px; width: 90%; max-height: 90%; overflow-y: auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">User Management</h2>
                    
                    <!-- Add New User Form -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px;">Add New User</h3>
                        <form id="addUserForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Username *</label>
                                <input type="text" id="newUsername" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Full Name *</label>
                                <input type="text" id="newFullName" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email</label>
                                <input type="email" id="newEmail" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Role *</label>
                                <select id="newRole" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                    <option value="">Select Role</option>
                                    <option value="admin">Administrator</option>
                                    <option value="manager">Manager</option>
                                    <option value="engineer">Engineer</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Password *</label>
                                <input type="password" id="newPassword" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Add User</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Current Session -->
                    <div style="margin-bottom: 30px; background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <h3>Current Session</h3>
                        <p><strong>User:</strong> ${currentUser.name} (${currentUser.username})</p>
                        <p><strong>Role:</strong> ${currentUser.role}</p>
                        <p><strong>Login Time:</strong> ${new Date(currentUser.loginTime).toLocaleString()}</p>
                    </div>
                    
                    <!-- Database Users -->
                    ${dbUsers.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h3>Database Users (${dbUsers.length})</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Username</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Full Name</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Email</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Role</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Last Login</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dbUsers.map(user => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">${user.username}</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">${user.full_name}</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">${user.email || 'N/A'}</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">${user.role}</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                                        <td style="padding: 10px; border: 1px solid #dee2e6;">
                                            <button onclick="editUser(${user.id})" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>
                                            <button onclick="deactivateUser(${user.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Deactivate</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : '<p style="color: #666; margin-bottom: 30px;">No database users found. Users will be created in the database when added.</p>'}
                    
                    <!-- Demo Users -->
                    <div style="margin-bottom: 30px;">
                        <h3>Demo Users (Hardcoded)</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Username</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Name</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Role</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Password</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 10px; border: 1px solid #dee2e6;">admin</td><td style="padding: 10px; border: 1px solid #dee2e6;">System Administrator</td><td style="padding: 10px; border: 1px solid #dee2e6;">admin</td><td style="padding: 10px; border: 1px solid #dee2e6;">admin123</td></tr>
                                <tr><td style="padding: 10px; border: 1px solid #dee2e6;">manager</td><td style="padding: 10px; border: 1px solid #dee2e6;">Quality Manager</td><td style="padding: 10px; border: 1px solid #dee2e6;">manager</td><td style="padding: 10px; border: 1px solid #dee2e6;">mgr123</td></tr>
                                <tr><td style="padding: 10px; border: 1px solid #dee2e6;">engineer</td><td style="padding: 10px; border: 1px solid #dee2e6;">Design Engineer</td><td style="padding: 10px; border: 1px solid #dee2e6;">engineer</td><td style="padding: 10px; border: 1px solid #dee2e6;">eng123</td></tr>
                                <tr><td style="padding: 10px; border: 1px solid #dee2e6;">viewer</td><td style="padding: 10px; border: 1px solid #dee2e6;">Quality Inspector</td><td style="padding: 10px; border: 1px solid #dee2e6;">viewer</td><td style="padding: 10px; border: 1px solid #dee2e6;">view123</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="closeUserManagement()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', userMgmtModal);
        
        // Add form submission handler
        document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
    });
}

// Handle add user form submission
async function handleAddUser(e) {
    e.preventDefault();
    
    const userData = {
        username: document.getElementById('newUsername').value,
        fullName: document.getElementById('newFullName').value,
        email: document.getElementById('newEmail').value,
        role: document.getElementById('newRole').value,
        password: document.getElementById('newPassword').value
    };
    
    // Basic validation
    if (userData.username.length < 3) {
        alert('Username must be at least 3 characters');
        return;
    }
    
    if (userData.password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
    }
    
    const success = await addNewUser(userData);
    
    if (success) {
        alert(`User ${userData.username} added successfully!`);
        closeUserManagement();
        showUserManagementEnhanced(); // Refresh the user list
    } else {
        alert('Failed to add user. Username may already exist.');
    }
}

// Deactivate user
async function deactivateUser(userId) {
    if (!confirm('Are you sure you want to deactivate this user?')) {
        return;
    }
    
    try {
        const result = await directApiCall('PATCH', `users?id=eq.${userId}`, {
            is_active: false
        });
        
        if (result.error) {
            throw result.error;
        }
        
        alert('User deactivated successfully');
        closeUserManagement();
        showUserManagementEnhanced(); // Refresh the list
        
    } catch (error) {
        alert('Failed to deactivate user');
        console.error('Deactivate user error:', error);
    }
}

// Edit User Functionality

// Show edit user modal
function editUser(userId) {
    loadUsersFromDatabase().then(users => {
        const user = users.find(u => u.id === userId);
        if (!user) {
            alert('User not found');
            return;
        }
        
        const editModal = `
            <div id="editUserModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 500px; width: 90%;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Edit User</h2>
                    
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId" value="${user.id}">
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Username</label>
                            <input type="text" id="editUsername" value="${user.username}" readonly style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em; background: #f8f9fa;">
                            <small style="color: #6c757d;">Username cannot be changed</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Full Name *</label>
                            <input type="text" id="editFullName" value="${user.full_name}" required style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Email</label>
                            <input type="email" id="editEmail" value="${user.email || ''}" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Role *</label>
                            <select id="editRole" required style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em;">
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrator (Full Access)</option>
                                <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager (Create & Edit)</option>
                                <option value="engineer" ${user.role === 'engineer' ? 'selected' : ''}>Engineer (Edit Only)</option>
                                <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer (Read Only)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">New Password</label>
                            <input type="password" id="editPassword" placeholder="Leave blank to keep current password" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 1em;">
                            <small style="color: #6c757d;">Only enter if you want to change the password</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="editIsActive" ${user.is_active ? 'checked' : ''} style="margin-right: 8px; width: 18px; height: 18px;">
                                <span style="font-weight: 600; color: #2c3e50;">Active User</span>
                            </label>
                            <small style="color: #6c757d; display: block; margin-top: 5px;">Uncheck to deactivate user login</small>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button type="submit" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer;">Save Changes</button>
                            <button type="button" onclick="closeEditUser()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer;">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', editModal);
        
        // Add form submission handler
        document.getElementById('editUserForm').addEventListener('submit', handleEditUser);
    });
}

// Handle edit user form submission
async function handleEditUser(e) {
    e.preventDefault();
    
    const userId = parseInt(document.getElementById('editUserId').value);
    const updateData = {
        full_name: document.getElementById('editFullName').value,
        email: document.getElementById('editEmail').value || null,
        role: document.getElementById('editRole').value,
        is_active: document.getElementById('editIsActive').checked
    };
    
    // Only update password if a new one was entered
    const newPassword = document.getElementById('editPassword').value;
    if (newPassword && newPassword.length > 0) {
        if (newPassword.length < 6) {
            alert('Password must be at least 6 characters');
            return;
        }
        updateData.password_hash = hashPassword(newPassword);
    }
    
    try {
        const result = await directApiCall('PATCH', `users?id=eq.${userId}`, updateData);
        
        if (result.error) {
            throw result.error;
        }
        
        alert('User updated successfully!');
        
        // If user edited themselves, update current session
        if (currentUser && currentUser.id === userId) {
            currentUser.name = updateData.full_name;
            currentUser.email = updateData.email;
            currentUser.role = updateData.role;
            userPermissions = ROLE_PERMISSIONS[updateData.role] || [];
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // If role changed, update UI
            updateUIForUser();
        }
        
        closeEditUser();
        closeUserManagement();
        showUserManagement(); // Refresh the user list
        
    } catch (error) {
        alert('Failed to update user. Please try again.');
        console.error('Update user error:', error);
    }
}

// Close edit user modal
function closeEditUser() {
    const modal = document.getElementById('editUserModal');
    if (modal) modal.remove();
}

// Update deactivate user function to use the edit functionality
async function deactivateUser(userId) {
    if (!confirm('Are you sure you want to deactivate this user? They will not be able to log in.')) {
        return;
    }
    
    try {
        const result = await directApiCall('PATCH', `users?id=eq.${userId}`, {
            is_active: false
        });
        
        if (result.error) {
            throw result.error;
        }
        
        alert('User deactivated successfully');
        closeUserManagement();
        showUserManagement(); // Refresh the list
        
    } catch (error) {
        alert('Failed to deactivate user');
        console.error('Deactivate user error:', error);
    }
}

// Add reactivate user function
async function reactivateUser(userId) {
    if (!confirm('Reactivate this user account?')) {
        return;
    }
    
    try {
        const result = await directApiCall('PATCH', `users?id=eq.${userId}`, {
            is_active: true
        });
        
        if (result.error) {
            throw result.error;
        }
        
        alert('User reactivated successfully');
        closeUserManagement();
        showUserManagement(); // Refresh the list
        
    } catch (error) {
        alert('Failed to reactivate user');
        console.error('Reactivate user error:', error);
    }
}

// Update the original handleLogin function to use database
const originalHandleLogin = handleLogin;
handleLogin = handleLoginDatabase;

// Update showUserManagement to use enhanced version
const originalShowUserManagement = showUserManagement;
showUserManagement = showUserManagementEnhanced;

// Initialize user management when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initializeUserManagement();
    }, 1000);
});

// Enhanced alert and task functions that log actions
const originalSaveAlert = saveAlertToDatabase;
saveAlertToDatabase = function(alertData) {
    logUserAction('save_alert', { alertId: alertData.id, priority: alertData.priority });
    return originalSaveAlert(alertData);
};

const originalSaveTask = saveTaskToDatabase;
saveTaskToDatabase = function(taskData) {
    logUserAction('save_task', { taskId: taskData.id, assignee: taskData.assignee });
    return originalSaveTask(taskData);
};
		
		// Export all data to JSON
function exportAllData() {
    const exportData = {
        alerts: alerts,
        tasks: tasks,
        exportDate: new Date().toISOString(),
        version: "1.0",
        metadata: {
            totalAlerts: alerts.length,
            totalTasks: tasks.length,
            alertIdCounter: alertIdCounter,
            taskIdCounter: taskIdCounter
        }
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `engineering_portal_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    alert(`Data exported successfully!\nAlerts: ${alerts.length}\nTasks: ${tasks.length}`);
}

// Export alerts to CSV
function exportAlertsToCSV() {
    if (alerts.length === 0) {
        alert('No alerts to export');
        return;
    }
    
    const csvHeaders = [
        'Alert ID', 'Customer/Supplier', 'Facility', 'Part Number', 'Revision Level',
        'Contact', 'Contact Phone', 'Contact Email', 'Department', 'Assigned To',
        'Report By', 'Reject Category', 'Qty Rejected', 'Qty Returned', 'Qty Scrapped',
        'Description', 'Root Cause', 'Corrective Action', 'Priority', 'Status',
        'Created Date', 'Due Date', 'Sign Off'
    ];
    
    const csvRows = alerts.map(alert => [
        alert.id,
        alert.customerSupplier || '',
        alert.facility || '',
        alert.partNumber || '',
        alert.revisionLevel || '',
        alert.contact || '',
        alert.contactPhone || '',
        alert.contactEmail || '',
        alert.department || '',
        alert.assignedTo || '',
        alert.reportBy || '',
        alert.rejectCategory || '',
        alert.qtyRejected || '',
        alert.qtyReturned || '',
        alert.qtyScrapped || '',
        `"${(alert.description || '').replace(/"/g, '""')}"`,
        `"${(alert.rootCause || '').replace(/"/g, '""')}"`,
        `"${(alert.correctiveAction || '').replace(/"/g, '""')}"`,
        alert.priority || '',
        alert.status || '',
        alert.createdDate || '',
        alert.dueDate || '',
        alert.correctiveSignOff || ''
    ]);
    
    const csvContent = [csvHeaders, ...csvRows]
        .map(row => row.join(','))
        .join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `quality_alerts_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// Export tasks to CSV
function exportTasksToCSV() {
    if (tasks.length === 0) {
        alert('No tasks to export');
        return;
    }
    
    const csvHeaders = [
        'Task ID', 'Title', 'Category', 'Description', 'Assignee', 'Department',
        'Reporter', 'Priority', 'Status', 'Due Date', 'Estimated Hours',
        'Actual Hours', 'Notes', 'Created Date'
    ];
    
    const csvRows = tasks.map(task => [
        task.id,
        `"${(task.title || '').replace(/"/g, '""')}"`,
        task.category || '',
        `"${(task.description || '').replace(/"/g, '""')}"`,
        task.assignee || '',
        task.department || '',
        task.reporter || '',
        task.priority || '',
        task.status || '',
        task.dueDate || '',
        task.estimatedHours || '',
        task.actualHours || '',
        `"${(task.notes || '').replace(/"/g, '""')}"`,
        task.createdDate || ''
    ]);
    
    const csvContent = [csvHeaders, ...csvRows]
        .map(row => row.join(','))
        .join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `engineering_tasks_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// Import data from JSON file
function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                // Validate data structure
                if (!importedData.alerts || !importedData.tasks) {
                    throw new Error('Invalid backup file format');
                }
                
                // Show confirmation dialog
                const alertCount = importedData.alerts.length;
                const taskCount = importedData.tasks.length;
                const exportDate = importedData.exportDate ? new Date(importedData.exportDate).toLocaleDateString() : 'Unknown';
                
                const confirmMessage = `Import backup data?\n\nFile contains:\n- ${alertCount} alerts\n- ${taskCount} tasks\n- Exported: ${exportDate}\n\nThis will REPLACE all current data!`;
                
                if (confirm(confirmMessage)) {
                    importDataConfirmed(importedData);
                }
                
            } catch (error) {
                alert(`Error reading backup file: ${error.message}\n\nPlease check that this is a valid Engineering Portal backup file.`);
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// Confirmed import function
async function importDataConfirmed(importedData) {
    try {
        // Store current data as safety backup
        const currentData = {
            alerts: [...alerts],
            tasks: [...tasks],
            alertIdCounter: alertIdCounter,
            taskIdCounter: taskIdCounter
        };
        
        // Import alerts
        for (const alert of importedData.alerts) {
            const success = await saveAlertToDatabase(alert);
            if (!success) {
                throw new Error(`Failed to import alert ${alert.id}`);
            }
        }
        
        // Import tasks
        for (const task of importedData.tasks) {
            const success = await saveTaskToDatabase(task);
            if (!success) {
                throw new Error(`Failed to import task ${task.id}`);
            }
        }
        
        // Update counters if provided
        if (importedData.metadata) {
            alertIdCounter = Math.max(alertIdCounter, importedData.metadata.alertIdCounter || alertIdCounter);
            taskIdCounter = Math.max(taskIdCounter, importedData.metadata.taskIdCounter || taskIdCounter);
        }
        
        // Reload data from database
        await loadAlertsFromDatabase();
        await loadTasksFromDatabase();
        updateAllStats();
        
        // Refresh current view
        if (currentPage === 'qualityAlerts') {
            showAllAlerts();
        } else if (currentPage === 'taskManagement') {
            showAllTasks();
        }
        
        alert(`Import completed successfully!\nImported ${importedData.alerts.length} alerts and ${importedData.tasks.length} tasks.`);
        
    } catch (error) {
        alert(`Import failed: ${error.message}\n\nSome data may have been imported. Please check your records.`);
        console.error('Import error:', error);
    }
}

// Import from CSV (alerts)
function importAlertsFromCSV() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const importedAlerts = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = parseCSVLine(lines[i]);
                    const alert = {};
                    
                    headers.forEach((header, index) => {
                        const value = values[index] || '';
                        // Map CSV headers to alert object properties
                        switch (header) {
                            case 'Alert ID': alert.id = value; break;
                            case 'Customer/Supplier': alert.customerSupplier = value; break;
                            case 'Facility': alert.facility = value; break;
                            case 'Part Number': alert.partNumber = value; break;
                            case 'Revision Level': alert.revisionLevel = value; break;
                            case 'Contact': alert.contact = value; break;
                            case 'Contact Phone': alert.contactPhone = value; break;
                            case 'Contact Email': alert.contactEmail = value; break;
                            case 'Department': alert.department = value; break;
                            case 'Assigned To': alert.assignedTo = value; break;
                            case 'Report By': alert.reportBy = value; break;
                            case 'Reject Category': alert.rejectCategory = value; break;
                            case 'Qty Rejected': alert.qtyRejected = parseInt(value) || 0; break;
                            case 'Qty Returned': alert.qtyReturned = parseInt(value) || 0; break;
                            case 'Qty Scrapped': alert.qtyScrapped = parseInt(value) || 0; break;
                            case 'Description': alert.description = value; break;
                            case 'Root Cause': alert.rootCause = value; break;
                            case 'Corrective Action': alert.correctiveAction = value; break;
                            case 'Priority': alert.priority = value; break;
                            case 'Status': alert.status = value; break;
                            case 'Created Date': alert.createdDate = value; break;
                            case 'Due Date': alert.dueDate = value; break;
                            case 'Sign Off': alert.correctiveSignOff = value; break;
                        }
                    });
                    
                    if (alert.id) {
                        importedAlerts.push(alert);
                    }
                }
                
                if (confirm(`Import ${importedAlerts.length} alerts from CSV?\nThis will add to existing data.`)) {
                    importAlertsConfirmed(importedAlerts);
                }
                
            } catch (error) {
                alert(`Error reading CSV file: ${error.message}`);
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// Helper function to parse CSV lines properly (handles quoted fields)
function parseCSVLine(line) {
    const values = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        
        if (char === '"' && inQuotes && nextChar === '"') {
            current += '"';
            i++; // Skip next quote
        } else if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    values.push(current.trim());
    return values;
}

// Confirmed CSV import for alerts
async function importAlertsConfirmed(importedAlerts) {
    try {
        let successCount = 0;
        let errorCount = 0;
        
        for (const alert of importedAlerts) {
            const success = await saveAlertToDatabase(alert);
            if (success) {
                successCount++;
            } else {
                errorCount++;
            }
        }
        
        await loadAlertsFromDatabase();
        updateAllStats();
        
        if (currentPage === 'qualityAlerts') {
            showAllAlerts();
        }
        
        alert(`CSV Import completed!\nSuccess: ${successCount}\nErrors: ${errorCount}`);
        
    } catch (error) {
        alert(`CSV Import failed: ${error.message}`);
        console.error('CSV Import error:', error);
    }
}
		
		// Utility function
function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

		// Handle custom reject category dropdown
		function toggleCustomRejectCategory() {
			const select = document.getElementById('rejectCategory');
			const customInput = document.getElementById('customRejectCategory');
    
			if (select.value === 'Custom') {
				customInput.style.display = 'block';
				customInput.required = true;
			} else {
				customInput.style.display = 'none';
				customInput.required = false;
				customInput.value = '';
			}
}

// ============================================
// PROJECT MANAGEMENT SYSTEM
// ============================================

let projects = [];
let projectIdCounter = 3001;
let currentProjectFilter = null;

// Auto-generate project number
function generateProjectNumber() {
    const year = new Date().getFullYear();
    const nextNum = String(projectIdCounter).padStart(3, '0');
    return `PRJ-${year}-${nextNum}`;
}

// Show Project Management page
function showProjectManagement() {
    currentPage = 'projects';
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('qualityAlertsPage').classList.add('hidden');
    document.getElementById('taskManagementPage').classList.add('hidden');
    document.getElementById('projectsPage').classList.remove('hidden');
    document.getElementById('breadcrumb').style.display = 'block';
    document.getElementById('currentPage').textContent = 'Project Management';
    loadProjectsFromDatabase();
    updateProjectStats();
}

// Secure project management functions
// Secure project management functions
function showProjectManagementSecure() {
    if (!requirePermission(PERMISSIONS.VIEW_TASKS, 'view projects')) {
        return;
    }
    showProjectManagement();
    
    // If viewer role, make form read-only after it's displayed
    if (currentUser && currentUser.role === USER_ROLES.VIEWER) {
        setTimeout(() => {
            makeProjectFormReadOnly();
        }, 100);
    }
}

function makeProjectFormReadOnly() {
    // Disable all form inputs
    const inputs = document.querySelectorAll('#createProjectForm input, #createProjectForm select, #createProjectForm textarea, #createProjectForm input[type="checkbox"]');
    inputs.forEach(input => {
        input.disabled = true;
    });
    
    // Hide the save button
    const submitBtn = document.querySelector('#projectForm button[type="submit"]');
    if (submitBtn) {
        submitBtn.style.display = 'none';
    }
    
    // Change cancel button text to "Close"
    const cancelBtn = document.querySelector('#projectForm button[onclick="cancelProjectForm()"]');
    if (cancelBtn) {
        cancelBtn.textContent = 'Close';
    }
}

function showCreateProjectFormSecure() {
    if (!requirePermission(PERMISSIONS.CREATE_TASKS, 'create projects')) {
        return;
    }
    showCreateProjectForm();
}

function editProjectSecure(id) {
    if (!requirePermission(PERMISSIONS.VIEW_TASKS, 'view projects')) {
        return;
    }
    
    // Allow viewers to VIEW but check edit permission for actual editing
    if (currentUser && currentUser.role !== USER_ROLES.VIEWER) {
        if (!requirePermission(PERMISSIONS.EDIT_TASKS, 'edit projects')) {
            return;
        }
    }
    
    editProject(id);
    
    // If viewer, make form read-only
    if (currentUser && currentUser.role === USER_ROLES.VIEWER) {
        setTimeout(() => {
            makeProjectFormReadOnly();
            document.getElementById('projectFormTitle').textContent = 'View Project (Read Only)';
        }, 100);
    }
}

function deleteProjectSecure(id) {
    if (!requirePermission(PERMISSIONS.DELETE_TASKS, 'delete projects')) {
        return;
    }
    deleteProject(id);
}


// Load projects from database
async function loadProjectsFromDatabase() {
    try {
        const result = await directApiCall('GET', 'projects?order=created_at.desc');
        if (result.error) throw result.error;
        
        projects = (result.data || []).map(p => ({
            id: p.id,
            projectNumber: p.project_number,
            customer: p.customer_name,
            partNumber: p.part_number,
            partDescription: p.part_description,
            projectManager: p.project_manager,
            startDate: p.start_date,
            targetCompletion: p.target_completion,
            actualCompletion: p.actual_completion,
            status: p.status,
            priority: p.priority,
            needs_pattern: p.needs_pattern,
            pattern_status: p.pattern_status,
            needs_oe_mold: p.needs_oe_mold,
            oe_mold_status: p.oe_mold_status,
            needs_me_mold: p.needs_me_mold,
            me_mold_status: p.me_mold_status,
            needs_trim_fixture: p.needs_trim_fixture,
            trim_fixture_status: p.trim_fixture_status,
            needs_assembly_fixture: p.needs_assembly_fixture,
            assembly_fixture_status: p.assembly_fixture_status,
            needs_check_fixture: p.needs_check_fixture,
            check_fixture_status: p.check_fixture_status,
            needs_drill_fixture: p.needs_drill_fixture,
            drill_fixture_status: p.drill_fixture_status,
            needs_trim_program: p.needs_trim_program,
            trim_program_status: p.trim_program_status,
            notes: p.notes,
            createdAt: p.created_at
        }));
        
         displayProjects(projects);
        updateProjectStats();
        
        // Set counter to highest existing project number + 1
        if (projects.length > 0) {
            const projectNumbers = projects
                .map(p => p.projectNumber.match(/PRJ-\d{4}-(\d{3})/))
                .filter(match => match)
                .map(match => parseInt(match[1]));
            if (projectNumbers.length > 0) {
                projectIdCounter = Math.max(...projectNumbers) + 1;
            }
        }
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

// Display projects in table
function displayProjects(projectsToShow) {
    const tbody = document.getElementById('projectsTableBody');
    if (!projectsToShow || projectsToShow.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No projects found</td></tr>';
        return;
    }
    
    tbody.innerHTML = projectsToShow.map(p => {
        const tooling = [];
        if (p.needs_pattern) tooling.push('Pattern');
        if (p.needs_oe_mold) tooling.push('OE Mold');
        if (p.needs_me_mold) tooling.push('ME Mold');
        if (p.needs_trim_fixture) tooling.push('Trim Fix');
        if (p.needs_assembly_fixture) tooling.push('Asm Fix');
        if (p.needs_check_fixture) tooling.push('Check Fix');
        if (p.needs_drill_fixture) tooling.push('Drill Fix');
        if (p.needs_trim_program) tooling.push('Trim Prog');
        
        return `
            <tr>
                <td><strong>${p.projectNumber}</strong></td>
                <td>${p.customer}</td>
                <td>${p.partNumber}</td>
                <td><span class="status-${p.status.toLowerCase().replace(' ', '-')}">${p.status}</span></td>
                <td class="priority-${p.priority.toLowerCase()}">${p.priority}</td>
                <td>${p.targetCompletion ? formatDate(p.targetCompletion) : 'Not set'}</td>
                <td style="font-size: 11px;">${tooling.join(', ') || 'None'}</td>
                <td>
                    <button class="btn" onclick="editProjectSecure(${p.id})" style="padding: 6px 10px; margin: 2px;">Edit</button>
                    <button class="btn" onclick="generatePASR(${p.id})" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 6px 10px; margin: 2px;">PASR</button>
                    <button class="btn" onclick="deleteProjectSecure(${p.id})" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 6px 10px; margin: 2px;">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

// Update project stats
function updateProjectStats() {
    document.getElementById('totalProjects').textContent = projects.length;
    document.getElementById('planningProjects').textContent = projects.filter(p => p.status === 'Planning').length;
    document.getElementById('activeProjects').textContent = projects.filter(p => p.status === 'In Progress').length;
    document.getElementById('completedProjects').textContent = projects.filter(p => p.status === 'Completed').length;
}

// Show create project form
function showCreateProjectForm() {
    document.getElementById('projectFormTitle').textContent = 'Create New Project';
    document.getElementById('projectForm').reset();
    document.getElementById('projectEditId').value = '';
    document.getElementById('projectNumber').value = generateProjectNumber(); // Auto-generate
    document.getElementById('createProjectForm').classList.remove('hidden');
    document.getElementById('projectsList').classList.add('hidden');
    
    ['pattern', 'oe_mold', 'me_mold', 'trim_fixture', 'assembly_fixture', 'check_fixture', 'drill_fixture', 'trim_program'].forEach(t => {
        document.getElementById(`${t}_status`).disabled = true;
    });
}

// Show all projects
function showAllProjects() {
    document.getElementById('createProjectForm').classList.add('hidden');
    document.getElementById('projectsList').classList.remove('hidden');
    displayProjects(currentProjectFilter ? projects.filter(p => p.status === currentProjectFilter) : projects);
}

// Toggle tooling status dropdown
function toggleToolingStatus(type) {
    const checkbox = document.getElementById(`needs_${type}`);
    const status = document.getElementById(`${type}_status`);
    status.disabled = !checkbox.checked;
    if (!checkbox.checked) status.value = 'Not Started';
}

// Handle project form submit
async function handleProjectSubmit(e) {
    e.preventDefault();
    
    const projectData = {
        project_number: document.getElementById('projectNumber').value,
        customer_name: document.getElementById('projectCustomer').value,
        part_number: document.getElementById('projectPartNumber').value,
        part_description: document.getElementById('projectPartDesc').value,
        project_manager: document.getElementById('projectManager').value,
        priority: document.getElementById('projectPriority').value,
        status: document.getElementById('projectStatus').value,
        start_date: document.getElementById('projectStartDate').value || null,
        target_completion: document.getElementById('projectTargetDate').value || null,
        actual_completion: document.getElementById('projectActualDate').value || null,
        needs_pattern: document.getElementById('needs_pattern').checked,
        pattern_status: document.getElementById('needs_pattern').checked ? document.getElementById('pattern_status').value : null,
        needs_oe_mold: document.getElementById('needs_oe_mold').checked,
        oe_mold_status: document.getElementById('needs_oe_mold').checked ? document.getElementById('oe_mold_status').value : null,
        needs_me_mold: document.getElementById('needs_me_mold').checked,
        me_mold_status: document.getElementById('needs_me_mold').checked ? document.getElementById('me_mold_status').value : null,
        needs_trim_fixture: document.getElementById('needs_trim_fixture').checked,
        trim_fixture_status: document.getElementById('needs_trim_fixture').checked ? document.getElementById('trim_fixture_status').value : null,
        needs_assembly_fixture: document.getElementById('needs_assembly_fixture').checked,
        assembly_fixture_status: document.getElementById('needs_assembly_fixture').checked ? document.getElementById('assembly_fixture_status').value : null,
        needs_check_fixture: document.getElementById('needs_check_fixture').checked,
        check_fixture_status: document.getElementById('needs_check_fixture').checked ? document.getElementById('check_fixture_status').value : null,
        needs_drill_fixture: document.getElementById('needs_drill_fixture').checked,
        drill_fixture_status: document.getElementById('needs_drill_fixture').checked ? document.getElementById('drill_fixture_status').value : null,
        needs_trim_program: document.getElementById('needs_trim_program').checked,
        trim_program_status: document.getElementById('needs_trim_program').checked ? document.getElementById('trim_program_status').value : null,
        notes: document.getElementById('projectNotes').value,
        created_by: currentUser ? currentUser.email : 'system'
    };
    
    const editId = document.getElementById('projectEditId').value;
    
    try {
        if (editId) {
            const result = await directApiCall('PATCH', `projects?id=eq.${editId}`, projectData);
            if (result.error) throw result.error;
            alert('Project updated successfully!');
         } else {
            const result = await directApiCall('POST', 'projects', projectData);
            if (result.error) throw result.error;
            projectIdCounter++; // Increment counter
            alert('Project created successfully!');
        }
        
        await loadProjectsFromDatabase();
        showAllProjects();
    } catch (error) {
        alert('Error saving project: ' + error.message);
        console.error('Save error:', error);
    }
}

// Edit project
async function editProject(id) {
    try {
        const result = await directApiCall('GET', `projects?id=eq.${id}`);
        if (result.error || !result.data || result.data.length === 0) throw new Error('Project not found');
        
        const p = result.data[0];
        
        document.getElementById('projectFormTitle').textContent = 'Edit Project';
        document.getElementById('projectEditId').value = p.id;
        document.getElementById('projectNumber').value = p.project_number;
        document.getElementById('projectCustomer').value = p.customer_name;
        document.getElementById('projectPartNumber').value = p.part_number;
        document.getElementById('projectPartDesc').value = p.part_description || '';
        document.getElementById('projectManager').value = p.project_manager || '';
        document.getElementById('projectPriority').value = p.priority;
        document.getElementById('projectStatus').value = p.status;
        document.getElementById('projectStartDate').value = p.start_date || '';
        document.getElementById('projectTargetDate').value = p.target_completion || '';
        document.getElementById('projectActualDate').value = p.actual_completion || '';
        document.getElementById('projectNotes').value = p.notes || '';
        
        ['pattern', 'oe_mold', 'me_mold', 'trim_fixture', 'assembly_fixture', 'check_fixture', 'drill_fixture', 'trim_program'].forEach(t => {
            const cb = document.getElementById(`needs_${t}`);
            const st = document.getElementById(`${t}_status`);
            cb.checked = p[`needs_${t}`] || false;
            st.disabled = !cb.checked;
            st.value = p[`${t}_status`] || 'Not Started';
        });
        
        document.getElementById('createProjectForm').classList.remove('hidden');
        document.getElementById('projectsList').classList.add('hidden');
    } catch (error) {
        alert('Error loading project');
        console.error(error);
    }
}

// Delete project
async function deleteProject(id) {
    if (!confirm('Delete this project?')) return;
    
    try {
        const result = await directApiCall('DELETE', `projects?id=eq.${id}`);
        if (result.error) throw result.error;
        
        alert('Project deleted successfully');
        await loadProjectsFromDatabase();
    } catch (error) {
        alert('Error deleting project');
        console.error(error);
    }
}

// Filter functions
function filterProjectsByStatus(status) {
    currentProjectFilter = status;
    displayProjects(projects.filter(p => p.status === status));
}

function clearProjectsFilters() {
    currentProjectFilter = null;
    displayProjects(projects);
}

function cancelProjectForm() {
    showAllProjects();
}	

// ============================================
// DOCUMENT MANAGEMENT SYSTEM
// ============================================

// Initialize Supabase Storage (uses existing supabase client)
const { createClient } = supabase;

// Upload documents for projects
async function uploadProjectDocuments() {
    const fileInput = document.getElementById('projectDocUpload');
    const docType = document.getElementById('projectDocType').value;
    const revision = document.getElementById('projectDocRevision').value;
    const projectId = document.getElementById('projectEditId').value;
    
    if (!fileInput.files.length) {
        alert('Please select at least one file');
        return;
    }
    
    if (!projectId) {
        alert('Please save the project first before uploading documents');
        return;
    }
    
    await uploadDocuments(fileInput.files, 'project', projectId, docType, revision);
    
    // Clear inputs
    fileInput.value = '';
    document.getElementById('projectDocType').value = '';
    document.getElementById('projectDocRevision').value = '';
    
    // Reload document list
    loadProjectDocuments(projectId);
}

// Generic upload function
async function uploadDocuments(files, type, recordId, docType, revision) {
    let successCount = 0;
    
    for (const file of files) {
        try {
            // Generate unique filename
            const timestamp = Date.now();
            const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
            const uniqueFilename = `${type}_${recordId}_${timestamp}_${sanitizedName}`;
            const filePath = `${type}s/${recordId}/${uniqueFilename}`;
            
            // Upload to Supabase Storage using REST API
            const formData = new FormData();
            formData.append('file', file);
            
            const uploadResponse = await fetch(`${SUPABASE_URL}/storage/v1/object/documents/${filePath}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'apikey': SUPABASE_ANON_KEY
                },
                body: file
            });
            
            if (!uploadResponse.ok) {
                const errorText = await uploadResponse.text();
                console.error('Upload failed:', errorText);
                throw new Error(`Upload failed: ${uploadResponse.status}`);
            }
            
            // Save metadata to database
            const documentData = {
                filename: uniqueFilename,
                original_filename: file.name,
                file_path: filePath,
                file_type: file.type,
                file_size: file.size,
                uploaded_by: currentUser ? currentUser.email : 'unknown',
                document_type: docType || null,
                revision: revision || null
            };
            
            // Add the appropriate ID field
            documentData[`${type}_id`] = parseInt(recordId);
            
            const result = await directApiCall('POST', 'documents', documentData);
            
            if (result.error) {
                console.error('Database save error:', result.error);
                throw result.error;
            }
            
            successCount++;
            
        } catch (error) {
            console.error(`Error uploading ${file.name}:`, error);
            alert(`Failed to upload ${file.name}: ${error.message}`);
        }
    }
    
    if (successCount > 0) {
        alert(`Successfully uploaded ${successCount} of ${files.length} file(s)`);
    }
}

// Load documents for a project
async function loadProjectDocuments(projectId) {
    if (!projectId) return;
    
    try {
        const result = await directApiCall('GET', `documents?project_id=eq.${projectId}&order=uploaded_at.desc`);
        if (result.error) throw result.error;
        
        displayDocuments(result.data || [], 'projectDocumentsList', 'project', projectId);
    } catch (error) {
        console.error('Error loading project documents:', error);
    }
}

// Display documents in list
function displayDocuments(documents, containerId, type, recordId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (documents.length === 0) {
        container.innerHTML = '<p style="color: #999; font-style: italic;">No documents uploaded yet</p>';
        return;
    }
    
    container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <thead>
                <tr style="background: #667eea;">
                    <th style="padding: 10px; text-align: left; color: white;">File Name</th>
                    <th style="padding: 10px; text-align: left; color: white;">Type</th>
                    <th style="padding: 10px; text-align: left; color: white;">Revision</th>
                    <th style="padding: 10px; text-align: left; color: white;">Size</th>
                    <th style="padding: 10px; text-align: left; color: white;">Uploaded</th>
                    <th style="padding: 10px; text-align: left; color: white;">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${documents.map(doc => `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 10px;">
                            ${isImage(doc.file_type) ? 'üñºÔ∏è' : 'üìÑ'} ${doc.original_filename}
                        </td>
                        <td style="padding: 10px;">${doc.document_type || 'N/A'}</td>
                        <td style="padding: 10px;">${doc.revision || '-'}</td>
                        <td style="padding: 10px;">${formatFileSize(doc.file_size)}</td>
                        <td style="padding: 10px;">${new Date(doc.uploaded_at).toLocaleDateString()}</td>
                        <td style="padding: 10px;">
                            <button onclick="downloadDocument('${doc.file_path}', '${doc.original_filename}')" class="btn" style="padding: 5px 10px; margin-right: 5px; font-size: 0.9em;">Download</button>
                            <button onclick="deleteDocument(${doc.id}, '${doc.file_path}', '${type}', ${recordId})" class="btn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 5px 10px; font-size: 0.9em;">Delete</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Check if file is an image
function isImage(mimeType) {
    return mimeType && mimeType.startsWith('image/');
}

// Format file size
function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Download document
async function downloadDocument(filePath, originalFilename) {
    try {
        const downloadUrl = `${SUPABASE_URL}/storage/v1/object/documents/${filePath}`;
        
        const response = await fetch(downloadUrl, {
            headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY
            }
        });
        
        if (!response.ok) throw new Error('Download failed');
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = originalFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('Download error:', error);
        alert('Failed to download file: ' + error.message);
    }
}

// Delete document
async function deleteDocument(docId, filePath, type, recordId) {
    if (!confirm('Delete this document? This action cannot be undone.')) {
        return;
    }
    
    try {
        // Delete from storage
        const deleteUrl = `${SUPABASE_URL}/storage/v1/object/documents/${filePath}`;
        await fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'apikey': SUPABASE_ANON_KEY
            }
        });
        
        // Delete from database
        const result = await directApiCall('DELETE', `documents?id=eq.${docId}`);
        if (result.error) throw result.error;
        
        alert('Document deleted successfully');
        
        // Reload document list
        if (type === 'project') {
            loadProjectDocuments(recordId);
        }
        
    } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete document: ' + error.message);
    }
}

// Update editProject to load documents when editing
const originalEditProject = editProject;
editProject = async function(id) {
    await originalEditProject(id);
    loadProjectDocuments(id);
};

// ============================================
// PASR GENERATION
// ============================================

// Generate PASR Report for a project
async function generatePASR(projectId) {
    try {
        const result = await directApiCall('GET', `projects?id=eq.${projectId}`);
        if (result.error || !result.data || result.data.length === 0) {
            alert('Project not found');
            return;
        }
        
        const project = result.data[0];
        
        const pasrHTML = `
<!DOCTYPE html>
<html>
<head>
    <title>PASR - ${project.part_number}</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: Arial, sans-serif;
        background: white;
        padding: 15px;
    }
    
    .container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 3px solid #003366;
    }
    
    .logo {
        font-size: 24px;
        font-weight: bold;
        color: #003366;
        letter-spacing: 2px;
    }
    
    .title {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 11px;
    }
    
    .info-item {
        text-align: center;
    }
    
    .info-label {
        font-size: 10px;
        font-weight: 700;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
    }
    
    .info-value {
        font-size: 13px;
        font-weight: 600;
        color: #003366;
    }
    
    .section {
        margin-bottom: 12px;
        border: 2px solid #003366;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .section-header {
        background: #003366;
        color: white;
        padding: 8px 15px;
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
    }
    
    .section-content {
        padding: 15px;
        background: white;
        min-height: 60px;
    }
    
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        font-size: 10px;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .checkbox {
        width: 16px;
        height: 16px;
        border: 2px solid #003366;
        border-radius: 3px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        background: white;
    }
    
    .checkbox.checked {
        background: #27ae60;
        border-color: #27ae60;
    }
    
    .checkbox.checked::after {
        content: '‚úì';
        color: white;
        font-size: 12px;
        font-weight: bold;
    }
    
    .checkbox-label {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        font-size: 10px;
    }
    
    .comments-box {
        min-height: 60px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 5px;
        font-size: 11px;
        line-height: 1.5;
        border: 1px dashed #ccc;
    }
    
    .completion-footer {
        margin-top: 15px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: center;
        border: 2px solid #003366;
    }
    
    .completion-date {
        font-size: 12px;
        font-weight: 700;
        color: #003366;
    }
    
    .print-controls {
        text-align: center;
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .print-btn {
        padding: 10px 24px;
        margin: 0 8px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .print-btn-primary {
        background: #003366;
        color: white;
    }
    
    .print-btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    @media print {
        body { 
            padding: 8px;
        }
        .no-print { 
            display: none;
        }
        .container {
            page-break-inside: avoid;
        }
        .section {
            page-break-inside: avoid;
            margin-bottom: 10px;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="no-print print-controls">
            <button onclick="window.print()" class="print-btn print-btn-primary">üñ®Ô∏è Print PASR</button>
            <button onclick="window.close()" class="print-btn print-btn-secondary">‚úï Close</button>
        </div>

        <div class="header">
            <div class="logo">VEE ENGINEERING INC.</div>
            <div class="title">PART APPROVAL STATUS REPORT</div>
        </div>

        <div class="content">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Customer</div>
                    <div class="info-value">${project.customer_name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Part Number</div>
                    <div class="info-value">${project.part_number}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Revision Level</div>
                    <div class="info-value">Rev ${project.notes || '1'}</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Reason for PASR</div>
                <div class="section-content">
                    <div class="checkbox-item">
                        <div class="checkbox checked"></div>
                        <div class="checkbox-label">New Part</div>
                    </div>
                    <div class="checkbox-item">
                        <div class="checkbox"></div>
                        <div class="checkbox-label">Part Revision</div>
                    </div>
                    <div class="checkbox-item">
                        <div class="checkbox"></div>
                        <div class="checkbox-label">Other</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Tooling Complete</div>
                <div class="section-content">
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <div class="checkbox ${project.needs_pattern && project.pattern_status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">Pattern</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox ${project.needs_assembly_fixture && project.assembly_fixture_status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">Assembly Fixture</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox ${project.needs_oe_mold && project.oe_mold_status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">OE Mold</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox ${project.needs_trim_fixture && project.trim_fixture_status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">Trim Fixture</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox ${project.needs_drill_fixture && project.drill_fixture_status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">Drill Fixture</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox ${project.needs_check_fixture && project.check_fixture_status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">Check Fixture</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox ${project.needs_me_mold && project.me_mold_status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">ME Mold</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox ${project.needs_trim_program && project.trim_program_status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">Trim Program</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Part / Tool Status</div>
                <div class="section-content">
                    <div class="status-grid">
                        <div class="checkbox-item">
                            <div class="checkbox ${project.status === 'Completed' ? 'checked' : ''}"></div>
                            <div class="checkbox-label">Approved</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox"></div>
                            <div class="checkbox-label">Conditional Approval</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox"></div>
                            <div class="checkbox-label">Process Sheets Complete</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox"></div>
                            <div class="checkbox-label">Tooling Moved to Required Department</div>
                        </div>
                        <div class="checkbox-item">
                            <div class="checkbox"></div>
                            <div class="checkbox-label">Invoice Tooling</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Comments</div>
                <div class="section-content">
                    <div class="comments-box">
                        ${project.notes || 'No additional comments'}
                    </div>
                </div>
            </div>

            <div class="completion-footer">
                <div class="completion-date">
                    Completion Date: ${project.actual_completion ? new Date(project.actual_completion).toLocaleDateString() : new Date().toLocaleDateString()}
                </div>
            </div>
        </div>
    </div>
</body>
</html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(pasrHTML);
        printWindow.document.close();
        
    } catch (error) {
        console.error('Error generating PASR:', error);
        alert('Failed to generate PASR: ' + error.message);
    }
}
</script>